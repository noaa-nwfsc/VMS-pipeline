---
title: "Overlay VMS points grid of choice and calcailate value of each 5km x 5km grid cell per year for dungeness crab"
output: 
  html_document:
    toc: true
    toc_float: true
---

## Purpose

Matching the output VMS data to a multi-region grid to use for summarizing fishing effort. Then, filtering data for crab fishing events and assigning revenue and pounds of DCRB to each geolocation.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs,message=FALSE,warning=FALSE}
library(tidyverse)
library(magrittr)
library(sf)
library(here)
library(knitr)
library(lubridate)
library(glue)
library(readr)
library(rnaturalearth) # for mapping states
library(viridis) # for good color scales
```

## All Data

We now match all of the VMS points from all years. We process each year just as one above.

### Import

```{r import all}
# clear workspace of everything but 5km grid
rm(list=setdiff(ls(),'grd'))

# load 2014-2023 fish ticket and VMS data
vms_all <- read_rds(here('Confidential', 'processed', 'matched', 'filtering', '2014_matched_filtered_withFTID_length.rds')) %>%
  bind_rows(read_rds(here('Confidential', 'processed', 'matched', 'filtering', '2015_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'processed', 'matched', 'filtering', '2016_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'processed', 'matched', 'filtering', '2017_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'processed', 'matched', 'filtering', '2018_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'processed', 'matched', 'filtering', '2019_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'processed', 'matched', 'filtering', '2020_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'processed', 'matched', 'filtering', '2021_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'processed', 'matched', 'filtering', '2022_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'processed', 'matched', 'filtering', '2023_matched_filtered_withFTID_length.rds')))

# take a look at imported data
glimpse(vms_all)
# check all years are present
unique(year(vms_all$date))
```

### Match

```{r}

# load 5x5 grid shapefile
grd <- read_sf(here('GIS_layers', 'master_5km_grid_tmer.shp'))

# convert VMS to spatial object
pt <- proc.time()
vms_all_sf <- vms_all %>%
  st_as_sf(coords= c('LON','LAT'), crs=4326) %>% 
  # then, convert to planar projection to match the grid
  st_transform(st_crs(grd))
x <- proc.time() - pt
```

Took `r round(x[3]/60,2)` minutes to do the conversion. Now for the join...

```{r join VMS with spatial object to grid}
# do the join
pt <- proc.time()
vms_all_grd_match <- vms_all_sf %>%
  st_join(grd)
x <- proc.time() - pt
```

The join took`r round(x[3]/60,2)` minutes.

### Save and Write

```{r}
# non-spatial version
glimpse(vms_all_grd_match)
vms_all_grd_match %>% 
  st_set_geometry(NULL) %>% 
  write_rds(here('Confidential', 'data', 'interim', 'vms_all_w_grd_5km.rds'))
```

## Prep data for DCRB focused analysis

The VMS data is now on the 5km grid,and I need to prepare it for Heather's CDFW data request, with a focus on DCRB fishing effort.

The code below is based on prep_data_for_scenario_df_function.R

Start by choosing which variables to use to filter to fishing locations only.

```{r fishing data prep 1}

# load non-spatial version written above
vms_all_grd_match <- read_rds(here('Confidential', 'data', 'interim', 'vms_all_w_grd_5km.rds'))
glimpse(vms_all_grd_match)
```

Now filter the data based on control variables above: California, DCRB trips only, commercial removal types only, slow vessel speeds. Need to add DEPTH_CATM, but for now ask Blake to filter based on NGDC_M or the depth of each grid cell.

```{r filter fishing data}

# set filter parameters
state_agency_code = "C" # filter for landings brought to California ports
target_rev <- "DCRB"
target_lbs <- "DCRB"
winter_months <- c("November", "December", "January", "February", "March") # used to set season as Winter or Spring-Summer
removal_types <- c("COMMERCIAL (NON-EFP)", "COMMERCIAL(DIRECT SALES)", "UNKNOWN")
max_speed <- 4.11556 # units of m/s. 4.11556m/s = 8knots (4DCRB) and 1.54333 m/s = 3 knots (4CHNK)
min_speed <- 0 # units = m/s

# filter data, add year/season columns, and select columns for analysis
dcrb_vms_tix_analysis <- vms_all_grd_match %>%
  filter(agency_code == state_agency_code) %>%
  filter(TARGET_rev == target_rev | TARGET_lbs == target_lbs) %>%
  # filter(removal_type_name %in% removal_types) %>% # TODO check if this needed after issue #19 fix
  filter(NGDC_M <= 0 & NGDC_M >= -150) %>% # filter for 0-150 M depth
  filter(avg_speed_recalc <= max_speed & avg_speed_recalc >= min_speed) %>%
  mutate(
    year = lubridate::year(westcoastdate_notime),
    year_month = paste0(lubridate::year(westcoastdate_notime),"_", substr(lubridate::ymd(westcoastdate_notime),6,7)),
    # substr() ensures month is a 2 digit value, e.g. February is "02" not "2"
    month = lubridate::month(westcoastdate_notime, label=TRUE, abbr = FALSE),
    month_as_numeric = month(westcoastdate_notime),
    season = as.character(ifelse(month %in% winter_months, "Winter", "Spring-Summer")),
    crab_year = ifelse(
      month_as_numeric >= 11, paste0(year, "_", 1+year), paste0(year-1, "_", year)
    )
  ) %>%
  dplyr::select(
      GRID5KM_ID, # grid cell ID
      Rec_ID, # fish ticket ID
      VMS_RECNO, # VMS ping ID
      drvid, # vessel ID
      westcoastdate_notime,
      year,
      crab_year, 
      year_month,
      month, 
      month_as_numeric,
      season,
      pacfin_port_code, 
      port_group_code, 
      NGDC_M, # depth
      TARGET_lbs, # target species by weight (filtered to "DCRB")
      TARGET_rev, # target species by revenue (filtered to "DCRB")
      DCRB_lbs, # dungeness crab catch weight
      DCRB_revenue # dungeness crab catch revenue
    )

# take a look at transformed data
glimpse(dcrb_vms_tix_analysis)

# check all crab years present
unique(dcrb_vms_tix_analysis$crab_year)
```

Distribute rev and lbs to grid cells. 

```{r distribute $ and lbs to cells}

# create new columns that attribute pings, lbs, and $ from each fish ticket 
# based on proportion of pings related to each ticket in each grid cell

# total records per trip (total number of VMS records associated with each fish ticket)
# one record = one fish ticket
VMSrecords_per_trip <- dcrb_vms_tix_analysis %>%
  group_by(Rec_ID) %>%
  summarise(trip_VMSrecords = n(),
            .groups = 'drop')

# join total records per trip to VMS and fish ticket data and calculate vessels, lbs, and $ per VMS ping
dcrb_vms_tix_analysis_TripInfo <- left_join(VMSrecords_per_trip, dcrb_vms_tix_analysis, by="Rec_ID") %>%
  mutate(
    DCRB_lbs_per_VMSlocation = DCRB_lbs/trip_VMSrecords,
    DCRB_rev_per_VMSlocation = DCRB_revenue/trip_VMSrecords,
    DCRB_Vessels_per_VMSlocation = 1/trip_VMSrecords
  )
glimpse(dcrb_vms_tix_analysis_TripInfo)

# summarize and normalize fishery effort at year, month and grid cell level
# based on Jameal's prep_data_for_scenario_df_function.R
dcrb_year_month_5km_df <- dcrb_vms_tix_analysis_TripInfo %>%
  group_by(crab_year, year, year_month, month_as_numeric, month, GRID5KM_ID) %>%
  summarise(
    DCRB_lbs = sum(DCRB_lbs_per_VMSlocation),
    DCRB_rev = sum(DCRB_rev_per_VMSlocation),
    DCRB_VMS_pings = n(),
    DCRB_Vessels = sum(DCRB_Vessels_per_VMSlocation),
    Unique_DCRB_Vessels = length(unique(as.character(drvid)))
  ) %>%
  ungroup() %>%
  mutate(
    # rescale pings to 0-1
    normalized_DCRB_VMS_pings = as.vector(scale(DCRB_VMS_pings, center = min(DCRB_VMS_pings), scale = diff(range(DCRB_VMS_pings)))),
    # above rescaling converts 1 ping to 0, so change it so that 1 ping, after re-scaling, has a scaled value equal to one half of the rescaled value of 2 pings
    normalized_DCRB_VMS_pings = ifelse(
      normalized_DCRB_VMS_pings == 0, 
      0.5 * min(normalized_DCRB_VMS_pings[normalized_DCRB_VMS_pings != min(normalized_DCRB_VMS_pings)]),
      normalized_DCRB_VMS_pings
    )
  )

# save interim outputs
write_rds(dcrb_vms_tix_analysis_TripInfo, here::here('Confidential', 'data', 'interim', 'dcrb_vms_tix_analysis_TripInfo.rds'))
write_rds(dcrb_year_month_5km_df, here::here('Confidential', 'data', 'interim', 'dcrb_year_month_5km_df.rds'))

# visualize # vms pings
dcrb_year_month_5km_df %>%
  ggplot(aes(DCRB_VMS_pings)) + geom_histogram(binwidth=5)
print(range(dcrb_year_month_5km_df$DCRB_VMS_pings))

# visualize normalized # vms pings
dcrb_year_month_5km_df %>%
  ggplot(aes(normalized_DCRB_VMS_pings)) + geom_histogram(binwidth=0.01)
print(range(dcrb_year_month_5km_df$normalized_DCRB_VMS_pings))
```

```{r create summaries}
# set baseline and implementation years
baseline_2014_2018_crab_years <- c("2014_2015", "2015_2016", "2016_2017", "2017_2018", "2018_2019")
baseline_2017_2018_crab_years <- c("2017_2018", "2018_2019")
implementation_2019_2023_crab_years <- c("2019_2020", "2020_2021", "2021_2022", "2022_2023", "2023_2024")

# summarize baseline data (2014-2018) at monthly temporal grain and grid cell ID spatial grain
baseline_2014_2018 <- dcrb_year_month_5km_df %>%
  filter(crab_year %in% baseline_2014_2018_crab_years) %>%
  group_by(GRID5KM_ID, month, month_as_numeric) %>%
  summarise(
    # take average by summing across years and dividing by # years
    # use sum / length instead of mean, because grid cells with 0 pings have no records, rather than a record with '0'
    avg_DCRB_lbs = sum(DCRB_lbs) / length(baseline_2014_2018_crab_years),
    avg_DCRB_rev = sum(DCRB_rev) / length(baseline_2014_2018_crab_years),
    avg_DCRB_VMS_pings = sum(DCRB_VMS_pings) / length(baseline_2014_2018_crab_years),
    avg_normalized_DCRB_VMS_pings = sum(normalized_DCRB_VMS_pings) / length(baseline_2014_2018_crab_years),
    avg_DCRB_Vessels = sum(DCRB_Vessels) / length(baseline_2014_2018_crab_years),
    # take minimum unique DCRB vessels across years
    min_Unique_DCRB_Vessels = min(Unique_DCRB_Vessels),
    .groups = 'drop'
  )
# explore output
names(baseline_2014_2018)
summary(baseline_2014_2018$avg_DCRB_VMS_pings)
summary(baseline_2014_2018$avg_normalized_DCRB_VMS_pings)
sort(unique(baseline_2014_2018$month_as_numeric))
# write output
write_rds(baseline_2014_2018, here::here('Confidential', 'processed', 'summaries', 'baseline_2014_2018.rds'))

# summarize baseline data (2017-2018) at monthly temporal grain and grid cell ID spatial grain
baseline_2017_2018 <- dcrb_year_month_5km_df %>%
  filter(crab_year %in% baseline_2017_2018_crab_years) %>%
  group_by(GRID5KM_ID, month, month_as_numeric) %>%
  summarise(
    # take average by summing across years and dividing by # years
    # use sum / length instead of mean, because grid cells with 0 pings have no records, rather than a record with '0'
    avg_DCRB_lbs = sum(DCRB_lbs) / length(baseline_2017_2018_crab_years),
    avg_DCRB_rev = sum(DCRB_rev) / length(baseline_2017_2018_crab_years),
    avg_DCRB_VMS_pings = sum(DCRB_VMS_pings) / length(baseline_2017_2018_crab_years),
    avg_normalized_DCRB_VMS_pings = sum(normalized_DCRB_VMS_pings) / length(baseline_2017_2018_crab_years),
    avg_DCRB_Vessels = sum(DCRB_Vessels) / length(baseline_2017_2018_crab_years),
    # take minimum unique DCRB vessels across years
    min_Unique_DCRB_Vessels = min(Unique_DCRB_Vessels),
    .groups = 'drop'
  )
# explore output
names(baseline_2017_2018)
sort(unique(baseline_2017_2018$month_as_numeric))
summary(baseline_2017_2018$avg_DCRB_VMS_pings)
summary(baseline_2017_2018$avg_normalized_DCRB_VMS_pings)
# write output
write_rds(baseline_2017_2018, here::here('Confidential', 'processed', 'summaries', 'baseline_2017_2018.rds'))

# write real-time data (2019-2023) at yearly and monthly temporal grain and grid cell ID spatial grain
implementation_2019_2023 <- dcrb_year_month_5km_df %>%
  filter(crab_year %in% implementation_2019_2023_crab_years)
# explore output
names(implementation_2019_2023)
sort(unique(implementation_2019_2023$month_as_numeric))
summary(implementation_2019_2023$DCRB_VMS_pings)
summary(implementation_2019_2023$normalized_DCRB_VMS_pings)
# write output
write_rds(implementation_2019_2023, here::here('Confidential', 'processed', 'summaries', 'implementation_2019_2023.rds'))
```

```{r visualize on map}

# based on Owen's compare_hw_bh.R

# West coast, using the rnaturalearth package (for a background map)
coaststates <- ne_states(country='United States of America',returnclass = 'sf') %>% 
  filter(name %in% c('California','Oregon','Washington','Nevada')) %>% 
  # spatially tranform to the same coordinate ref system as the 5k grid
  st_transform(st_crs(grd))

# visualize 2014-2018 baseline
# join summary back to geometry by GRID5KM_ID
baseline_2014_2018_with_grid <- baseline_2014_2018 %>% 
  left_join(grd, by = join_by(GRID5KM_ID)) %>%
  st_as_sf()
# set bounding box 
bbox <- st_bbox(baseline_2014_2018_with_grid)
# plot log of avg. pings on a map
map_log_pings_baseline_2014_2018 <- ggplot()+
  # background map
  geom_sf(data = coaststates, fill = 'gray80')+
  # 5KM grid with pings. Scale fill color by number of pings
  geom_sf(data = baseline_2014_2018_with_grid, aes(fill = log10(avg_DCRB_VMS_pings)), color = NA) +
  scale_fill_viridis() +
  # set manual bounding box
  xlim(bbox[1], bbox[3]) + ylim(bbox[2], bbox[4]) +
  labs(fill="log10(Avg. Pings)") +
  theme_minimal()
map_log_pings_baseline_2014_2018

# visualize 2017-2018 baseline
# join summary back to geometry by GRID5KM_ID
baseline_2017_2018_with_grid <- baseline_2017_2018 %>% 
  left_join(grd, by = join_by(GRID5KM_ID)) %>%
  st_as_sf()
# set bounding box
bbox <- st_bbox(baseline_2017_2018_with_grid)
# plot log of avg. pings on a map
map_log_pings_baseline_2017_2018 <- ggplot()+
  # background map
  geom_sf(data = coaststates, fill = 'gray80')+
  # 5KM grid with pings. Scale fill color by number of pings
  geom_sf(data = baseline_2017_2018_with_grid, aes(fill = log10(avg_DCRB_VMS_pings)), color = NA) +
  scale_fill_viridis() +
  # set manual bounding box
  xlim(bbox[1], bbox[3]) + ylim(bbox[2], bbox[4]) +
  labs(fill="log10(Avg. Pings)") +
  theme_minimal()
map_log_pings_baseline_2017_2018

# visualize 2019-2023 implementation period
# join summary back to geometry by GRID5KM_ID
implementation_2019_2023_with_grid <- implementation_2019_2023 %>% 
  left_join(grd, by = join_by(GRID5KM_ID)) %>%
  st_as_sf()
# set bounding box
bbox <- st_bbox(implementation_2019_2023_with_grid)
# plot log of avg. pings on a map
map_log_pings_implementation_2019_2023 <- ggplot()+
  # background map
  geom_sf(data = coaststates, fill = 'gray80')+
  # 5KM grid with pings. Scale fill color by number of pings
  geom_sf(data = implementation_2019_2023_with_grid, aes(fill = log10(DCRB_VMS_pings)), color = NA) +
  facet_grid(. ~ crab_year) +
  scale_fill_viridis() +
  # set manual bounding box
  xlim(bbox[1], bbox[3]) + ylim(bbox[2], bbox[4]) +
  labs(fill="log10(Pings)") +
  theme_minimal()
map_log_pings_implementation_2019_2023
```
