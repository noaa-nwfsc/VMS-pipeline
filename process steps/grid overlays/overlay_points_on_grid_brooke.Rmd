---
title: "Overlay VMS points grid of choice and calcailate value of each 5km x 5km grid cell per year for dungeness crab"
output: 
  html_document:
    toc: true
    toc_float: true
---

## Purpose

Matching the output VMS data to a multi-region grid to use for summarizing fishing effort. Then, filtering data for crab fishing events and assigning revenue and pounds of DCRB to each geolocation.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs,message=FALSE,warning=FALSE}
library(tidyverse)
library(magrittr)
library(sf)
library(here)
library(knitr)
library(lubridate)
library(glue)
library(readr)
```

## Sample Year

Import files for an example year to match. We use the matched, filtered with FTID VMS data

```{r}
# matched and filteredVMS Pipeline data from 2009 produced by Blake Feist 28 May 2024
vms2014 <- read_rds(here('Confidential','processed','matched','filtering','2014_matched_filtered_withFTID_length.rds'))

# 5x5 grid shapefile
grd <- read_sf(here('GIS_layers', 'master_5km_grid_tmer.shp')) 
names(grd)
```

## Match Points

```{r}
# convert vms to spatial object (longitude/latitude)
vms_sf <- vms2014 %>%
  st_as_sf(coords=c('LON','LAT'),crs=4326) %>% 
  # then, convert to planar projection to match the grid
  st_transform(st_crs(grd))

# do the join
pt <- proc.time()
vms_grd_match <- vms_sf %>%
  st_join(grd)
proc.time() - pt
```

## Check

Did the join work? How many unique 5km, 25km, and 50km cells are represented in the 2014 data?

```{r checks}
names(vms_grd_match)
length(unique(vms_grd_match$GRID5KM_ID))
```

## All Data

We now match all of the VMS points from all years. We process each year just as one above.

### Import

```{r import all}
# clear workspace of everything but 5km grid
rm(list=setdiff(ls(),'grd'))

# load 2014-2023 fish ticket and VMS data
vms_all <- read_rds(here('Confidential', 'data', 'interim', '2014_matched_filtered_withFTID_length.rds')) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2015_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2016_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2017_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2018_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2019_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2020_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2021_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2022_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2023_matched_filtered_withFTID_length.rds')))

# take a look at imported data
glimpse(vms_all)
# check all years are present
unique(year(vms_all$date))
```

### Match

```{r}
# convert VMS to spatial object
pt <- proc.time()
vms_all_sf <- vms_all %>%
  st_as_sf(coords= c('LON','LAT'), crs=4326) %>% 
  # then, convert to planar projection to match the grid
  st_transform(st_crs(grd))
x <- proc.time() - pt
```

Took `r round(x[3]/60,2)` minutes to do the conversion. Now for the join...

```{r join VMS with spatial object to grid}
# do the join
pt <- proc.time()
vms_all_grd_match <- vms_all_sf %>%
  st_join(grd)
x <- proc.time() - pt
```

The join took`r round(x[3]/60,2)` minutes.

### Save and Write

```{r}
# non-spatial version
glimpse(vms_all_grd_match)
vms_all_grd_match %>% 
  st_set_geometry(NULL) %>% 
  write_rds(here('Confidential', 'data', 'interim', 'vms_all_w_grd_5km.rds'))
```

## Prep data for DCRB focused analysis

The VMS data is now on the 5km grid,and I need to prepare it for Heather's CDFW data request, with a focus on DCRB fishing effort.

The code below is based on prep_data_for_scenario_df_function.R

Start by choosing which variables to use to filter to fishing locations only.

```{r fishing data prep 1}

# load non-spatial version written above
vms_all_grd_match <- read_rds(here('Confidential', 'data', 'interim', 'vms_all_w_grd_5km.rds'))
glimpse(vms_all_grd_match)
```

Now filter the data based on control variables above: California, DCRB trips only, commercial removal types only, slow vessel speeds. Need to add DEPTH_CATM, but for now ask Blake to filter based on NGDC_M or the depth of each grid cell.

```{r filter fishing data}

# set filter parameters
state_agency_code = "C" # filter for landings brought to California ports
target_rev <- "DCRB"
target_lbs <- "DCRB"
winter_months <- c("November", "December", "January", "February", "March") # used to set season as Winter or Spring-Summer
removal_types <- c("COMMERCIAL (NON-EFP)", "COMMERCIAL(DIRECT SALES)", "UNKNOWN")
max_speed <- 4.11556 # units of m/s. 4.11556m/s = 8knots (4DCRB) and 1.54333 m/s = 3 knots (4CHNK)
min_speed <- 0 # units = m/s

# filter data, add year/season columns, and select columns for analysis
dcrb_vms_tix_analysis <- vms_all_grd_match %>%
  filter(agency_code == state_agency_code) %>%
  filter(TARGET_rev == target_rev | TARGET_lbs == target_lbs) %>%
  filter(removal_type_name %in% removal_types) %>%
  filter(NGDC_M <= 0 & NGDC_M >= -150) %>% # filter for 0-150 M depth
  filter(avg_speed_recalc <= max_speed & avg_speed_recalc >= min_speed) %>%
  mutate(
    year = lubridate::year(westcoastdate_notime),
    year_month = paste0(lubridate::year(westcoastdate_notime),"_", substr(lubridate::ymd(westcoastdate_notime),6,7)),
    # substr() ensures month is a 2 digit value, e.g. February is "02" not "2"
    month = lubridate::month(westcoastdate_notime, label=TRUE, abbr = FALSE),
    month_as_numeric = month(westcoastdate_notime),
    season = as.character(ifelse(month %in% winter_months, "Winter", "Spring-Summer")),
    crab_year = ifelse(
      month_as_numeric >= 11, paste0(year, "_", 1+year), paste0(year-1, "_", year)
    )
  ) %>%
  dplyr::select(
      GRID5KM_ID, # grid cell ID
      Rec_ID, # fish ticket ID
      VMS_RECNO, # VMS ping ID
      drvid, # vessel ID
      westcoastdate_notime,
      year,
      crab_year, 
      year_month,
      month, 
      month_as_numeric,
      season,
      pacfin_port_code, 
      port_group_code, 
      NGDC_M, # depth
      TARGET_lbs, # target species by weight (filtered to "DCRB")
      TARGET_rev, # target species by revenue (filtered to "DCRB")
      DCRB_lbs, # dungeness crab catch weight
      DCRB_revenue # dungeness crab catch revenue
    )

# take a look at transformed data
glimpse(dcrb_vms_tix_analysis)

# check all crab years present
unique(dcrb_vms_tix_analysis$crab_year)

```

Distribute rev and lbs to grid cells. 

```{r distribute $ and lbs to cells}

# create new columns that attribute pings, lbs, and $ from each fish ticket 
# based on proportion of pings related to each ticket in each grid cell

# total records per trip (total number of VMS records associated with each fish ticket)
# one record = one fish ticket
VMSrecords_per_trip <- dcrb_vms_tix_analysis %>%
  group_by(Rec_ID) %>%
  summarise(trip_VMSrecords = n(),
            .groups = 'drop')

# join total records per trip to VMS and fish ticket data and calculate vessels, lbs, and $ per VMS ping
dcrb_vms_tix_analysis_TripInfo <- left_join(VMSrecords_per_trip, dcrb_vms_tix_analysis, by="Rec_ID") %>%
  mutate(
    DCRB_lbs_per_VMSlocation = DCRB_lbs/trip_VMSrecords,
    DCRB_rev_per_VMSlocation = DCRB_revenue/trip_VMSrecords,
    DCRB_Vessels_per_VMSlocation = 1/trip_VMSrecords
  )
glimpse(dcrb_vms_tix_analysis_TripInfo)

# save interim output
write_rds(dcrb_vms_tix_analysis_TripInfo, here::here('Confidential', 'data', 'interim', 'dcrb_vms_tix_analysis_TripInfo.rds'))
```

```{r create summaries}
# set baseline and implementation years
baseline_2014_2018_crab_years <- c("2014_2015", "2015_2016", "2016_2017", "2017_2018", "2018_2019")
baseline_2017_2018_crab_years <- c("2017_2018", "2018_2019")
realtime_2019_2023_crab_years <- c("2019_2020", "2020_2021", "2021_2022", "2022_2023", "2023_2024")

# summarize baseline data (2014-2018) at monthly temporal grain and grid cell ID spatial grain
baseline_2014_2018 <- dcrb_vms_tix_analysis_TripInfo %>%
  filter(crab_year %in% baseline_2014_2018_crab_years) %>%
  # filter(year >= 2014 & year <= 2018) %>%
  group_by(GRID5KM_ID, month, month_as_numeric) %>%
  summarise(
    DCRB_lbs = sum(DCRB_lbs_per_VMSlocation),
    DCRB_rev = sum(DCRB_rev_per_VMSlocation),
    DCRB_VMS_pings = n(),
    DCRB_Vessels = sum(DCRB_Vessels_per_VMSlocation),
    Unique_DCRB_Vessels = length(unique(as.character(drvid))),
    .groups = 'drop'
  )
glimpse(baseline_2014_2018)
summary(baseline_2014_2018$DCRB_VMS_pings)
sort(unique(baseline_2014_2018$month_as_numeric))
write_rds(baseline_2014_2018, here::here('Confidential', 'data', 'processed', 'baseline_2014_2018.rds'))

# summarize baseline data (2017-2018) at monthly temporal grain and grid cell ID spatial grain
baseline_2017_2018 <- dcrb_vms_tix_analysis_TripInfo %>%
  filter(crab_year %in% baseline_2017_2018_crab_years) %>%
  # filter(year >= 2017 & year <= 2018) %>%
  group_by(GRID5KM_ID, month, month_as_numeric) %>%
  summarise(
    DCRB_lbs = sum(DCRB_lbs_per_VMSlocation),
    DCRB_rev = sum(DCRB_rev_per_VMSlocation),
    DCRB_VMS_pings = n(),
    DCRB_Vessels = sum(DCRB_Vessels_per_VMSlocation),
    Unique_DCRB_Vessels = length(unique(as.character(drvid))),
    .groups = 'drop'
  )
glimpse(baseline_2017_2018)
summary(baseline_2017_2018$DCRB_VMS_pings)
sort(unique(baseline_2017_2018$month_as_numeric))
write_rds(baseline_2017_2018, here::here('Confidential', 'data', 'processed', 'baseline_2017_2018.rds'))

# summarize real-time data (2019-2023) at yearly and monthly temporal grain and grid cell ID spatial grain
realtime_2019_2023 <- dcrb_vms_tix_analysis_TripInfo %>%
  filter(crab_year %in% realtime_2019_2023_crab_years) %>%
  # filter(year >= 2019 & year <= 2023) %>%
  group_by(GRID5KM_ID, year_month, year, month, month_as_numeric) %>%
  summarise(
    DCRB_lbs = sum(DCRB_lbs_per_VMSlocation),
    DCRB_rev = sum(DCRB_rev_per_VMSlocation),
    DCRB_VMS_pings = n(),
    DCRB_Vessels = sum(DCRB_Vessels_per_VMSlocation),
    Unique_DCRB_Vessels = length(unique(as.character(drvid))),
    .groups = 'drop'
  )
glimpse(realtime_2019_2023)
summary(realtime_2019_2023$DCRB_VMS_pings)
sort(unique(realtime_2019_2023$year_month))
write_rds(realtime_2019_2023, here::here('Confidential', 'data', 'processed', 'realtime_2019_2023.rds'))
```

```{r visualize on map}

# based on Owen's compare_hw_bh.R

library(rnaturalearth) # for mapping states
library(viridis) # for good color scales

# shapefile with grid info
# gr <- read_sf(here('GIS_layers', 'master_5km_grid_tmer.shp'))
# commented out, read in already as grd

# should be able to just join this by GRID5KM_ID
# all of the spatial data is stored in the special sf package 'geometry' column
baseline_2014_2018_with_grid <- baseline_2014_2018 %>% 
  left_join(grd, by = join_by(GRID5KM_ID)) %>%
  st_as_sf()
# hw <- hw %>% left_join(plot_grid, by = join_by(GRID5KM_ID)) %>% st_as_sf()
# commented out, not comparing yet

# West coast, using the rnaturalearth package (for a background map)
coaststates <- ne_states(country='United States of America',returnclass = 'sf') %>% 
  filter(name %in% c('California','Oregon','Washington','Nevada')) %>% 
  # spatially tranform to the same coordinate ref system as the 5k grid
  st_transform(st_crs(grd))

# plot, e.g., pings from February 2019
#bh_feb19 <-  bh %>% 
#  filter(year==2019,month_as_numeric==2)
# commented out, want to see full baseline to start

# bounding box 
#(so we aren't to zoomed out. also can futz with this to change what area you want to plot)
bbox <- st_bbox(baseline_2014_2018_with_grid)

# plot pings on a map
map_pings_baseline_2014_2018 <- ggplot()+
  # background map
  geom_sf(data = coaststates, fill = 'gray80')+
  # 5KM grid with pings. Scale fill color by number of pings
  geom_sf(data = baseline_2014_2018_with_grid, aes(fill = DCRB_VMS_pings), color = NA)+
  scale_fill_viridis()+
  # set manual bounding box
  xlim(bbox[1], bbox[3]) + ylim(bbox[2], bbox[4]) +
  labs(fill="Pings") +
  theme_minimal()
map_pings_baseline_2014_2018

# plot log pings on a map
map_log_pings_baseline_2014_2018 <- ggplot()+
  # background map
  geom_sf(data = coaststates, fill = 'gray80')+
  # 5KM grid with pings. Scale fill color by number of pings
  geom_sf(data = baseline_2014_2018_with_grid, aes(fill = log10(DCRB_VMS_pings)), color = NA)+
  scale_fill_viridis()+
  # set manual bounding box
  xlim(bbox[1], bbox[3]) + ylim(bbox[2], bbox[4]) +
  labs(fill="log10(Pings)") +
  theme_minimal()
map_log_pings_baseline_2014_2018

```

```{r compare to 2019 output}

```
