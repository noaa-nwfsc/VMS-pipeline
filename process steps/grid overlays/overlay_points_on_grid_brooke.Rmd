---
title: "Overlay VMS points grid of choice and calcailate value of each 5km x 5km grid cell per year for dungeness crab"
output: 
  html_document:
    toc: true
    toc_float: true
---

## Purpose

Matching the output VMS data to a multi-region grid to use for summarizing fishing effort. Then, filtering data for crab fishing events and assigning revenue and pounds of DCRB to each geolocation.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs,message=FALSE,warning=FALSE}
library(tidyverse)
library(magrittr)
library(sf)
library(here)
library(knitr)
library(lubridate)
library(glue)
library(readr)
```

## Sample Year

Import files for an example year to match. We use the matched, filtered with FTID VMS data

```{r}
# matched and filteredVMS Pipeline data from 2009 produced by Blake Feist 28 May 2024
vms2014 <- read_rds(here('Confidential', 'data', 'interim', '2014_matched_filtered_withFTID_length.rds'))

# 5x5 grid shapefile
grd <- read_sf(here('GIS_layers', 'master_5km_grid_tmer.shp')) 
names(grd)
```

## Match Points

```{r}
# convert vms to spatial object (longitude/latitude)
vms_sf <- vms2014 %>%
  st_as_sf(coords=c('LON','LAT'),crs=4326) %>% 
  # then, convert to planar projection to match the grid
  st_transform(st_crs(grd))

# do the join
pt <- proc.time()
vms_grd_match <- vms_sf %>%
  st_join(grd)
proc.time() - pt
```

## Check

Did the join work? How many unique 5km, 25km, and 50km cells are represented in the 2014 data?

```{r checks}
names(vms_grd_match)
length(unique(vms_grd_match$GRID5KM_ID)) # TODO check 8742 is reasonable number of grid cells
```

## All Data

We now match all of the VMS points from all years. We process each year just as one above.

### Import

```{r import all}
# clear workspace of everything but 5km grid
rm(list=setdiff(ls(),'grd'))
# TODO put in a loop using paste, e.g. for y in years paste(y,'_matched_filtered_withFTID_length.rds', sep='')

# load 2014-2023 fish ticket and VMS data
vms_all <- read_rds(here('Confidential', 'data', 'interim', '2014_matched_filtered_withFTID_length.rds')) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2015_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2016_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2017_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2018_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2019_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2020_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2021_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2022_matched_filtered_withFTID_length.rds'))) %>%
  bind_rows(read_rds(here('Confidential', 'data', 'interim', '2023_matched_filtered_withFTID_length.rds')))

glimpse(vms_all)

# TODO put the # years check back, add some other checks like # grid cells and year_month as well

```

### Match

```{r}
# convert VMS to spatial object
pt <- proc.time()
vms_all_sf <- vms_all %>%
  st_as_sf(coords= c('LON','LAT'), crs=4326) %>% 
  # then, convert to planar projection to match the grid
  st_transform(st_crs(grd))
x <- proc.time() - pt
```

Took `r round(x[3]/60,2)` minutes to do the conversion. Now for the join...

```{r join VMS with spatial object to grid}
# do the join
pt <- proc.time()
vms_all_grd_match <- vms_all_sf %>%
  st_join(grd)
x <- proc.time() - pt
```

The join took`r round(x[3]/60,2)` minutes.

### Save and Write

```{r}
# non-spatial version
glimpse(vms_all_grd_match)
vms_all_grd_match %>% 
  st_set_geometry(NULL) %>% 
  write_rds(here('Confidential', 'data', 'interim', 'vms_all_w_grd_5km.rds'))
```

## Prep data for DCRB focused analysis

The VMS data is now on the 5km grid,and I need to prepare it for Heather's CDFW data request, with a focus on DCRB fishing effort.

The code below is based on prep_data_for_scenario_df_function.R

Start by choosing which variables to use to filter to fishing locations only.

```{r fishing data prep 1}

# TODO possibly delete this line, not needed since vms_all_grd_match was just generated?
vms_all_grd_match <- read_rds(here('Confidential', 'data', 'interim', 'vms_all_w_grd_5km.rds'))
glimpse(vms_all_grd_match)
```

Now filter the data based on control variables above: California, DCRB trips only, commercial removal types only, slow vessel speeds. Need to add DEPTH_CATM, but for now ask Blake to filter based on NGDC_M or the depth of each grid cell.

```{r filter fishing data}

# set filter parameters
state_agency_code = "C" # TODO check if this is correct way to filter for California data, or if should be done by grid cell or coordinates instead
target_rev <- "DCRB"
target_lbs <- "DCRB"
winter_months <- c("November", "December", "January", "February", "March") # used to set season as Winter or Spring-Summer
removal_types <- c("COMMERCIAL (NON-EFP)", "COMMERCIAL(DIRECT SALES)", "UNKNOWN") # TODO does unknown cover much?
max_speed <- 4.11556 # units of m/s. 4.11556m/s = 8knots (4DCRB) and 1.54333 m/s = 3 knots (4CHNK)
min_speed <- 0 # units = m/s

# filter data, add year/season columns, and select columns for analysis
dcrb_vms_tix_analysis <- vms_all_grd_match %>%
  filter(agency_code == state_agency_code) %>%
  filter(TARGET_rev == target_rev | TARGET_lbs == target_lbs) %>%
  filter(removal_type_name %in% removal_types) %>%
  filter(avg_speed_recalc <= max_speed & avg_speed_recalc >= min_speed) %>%
  # TODO confirm removed filters that were commented out is ok
    # TODO confirm ok to remove DEPTH)CATM and NGDC_M filters? 
    # TODO confirm ok to remove in_port = NA filter?
    # TODO need any filter for port_group_code?
  mutate(
    year = lubridate::year(westcoastdate_notime),
    year_month = paste0(lubridate::year(westcoastdate_notime),"_", substr(lubridate::ymd(westcoastdate_notime),6,7)),
    # substr() ensures month is a 2 digit value, e.g. February is "02" not "2"
    month = lubridate::month(westcoastdate_notime, label=TRUE, abbr = FALSE),
    month_as_numeric = month(westcoastdate_notime),
    season = as.character(ifelse(month %in% winter_months, "Winter", "Spring-Summer")),
    crab_year = ifelse(month_as_numeric >= 11, paste0(year, "_", 1+year), paste0(year-1, "_", year))
    # e.g. for Nov. 2014, crab_year is 2014_2015. for Oct. 2014, crab_year is 2013_2014
  ) %>%
  dplyr::select(
      GRID5KM_ID, 
      Rec_ID,
      VMS_RECNO,
      drvid,
      westcoastdate_notime,
      year,
      crab_year, 
      year_month,
      month, 
      month_as_numeric,
      season,
      pacfin_port_code, 
      port_group_code, 
      NGDC_M,
      TARGET_lbs, 
      TARGET_rev, 
      DCRB_lbs, 
      DCRB_revenue
    ) 

glimpse(dcrb_vms_tix_analysis)
```

Distribute rev and lbs to grid cells. 

```{r distribute $ and lbs to cells}

# create new columns that attribute pings, lbs, and $ from each fish ticket 
# based on proportion of pings related to each ticket in each grid cell

# total records per trip (total number of VMS records associated with each fish ticket)
# one record = one fish ticket # TODO ...right? confirm
VMSrecords_per_trip <- dcrb_vms_tix_analysis %>%
  group_by(Rec_ID) %>%
  summarise(trip_VMSrecords = n(),
            .groups = 'drop') # %>%
  # filter(trip_VMSrecords > 1) # TODO why filter here?

# join total records per trip to VMS and fish ticket data and calculate vessels, lbs, and $ per VMS ping
dcrb_vms_tix_analysis_TripInfo <- left_join(VMSrecords_per_trip, dcrb_vms_tix_analysis, by="Rec_ID") %>%
  mutate(
    DCRB_lbs_per_VMSlocation = DCRB_lbs/trip_VMSrecords,
    DCRB_rev_per_VMSlocation = DCRB_revenue/trip_VMSrecords,
    DCRB_Vessels_per_VMSlocation = 1/trip_VMSrecords
  )
glimpse(dcrb_vms_tix_analysis_TripInfo)

# save interim output
write_rds(dcrb_vms_tix_analysis_TripInfo, here::here('Confidential', 'data', 'interim', 'dcrb_vms_tix_analysis_TripInfo.rds'))

# TODO is this the right number of records generated each time? not sure how many grid cells there are, or where to expect 0's

# summarize baseline data (2014-2018) at monthly temporal grain and grid cell ID spatial grain
baseline_2014_2018 <- dcrb_vms_tix_analysis_TripInfo %>%
  filter(year >= 2014 & year <= 2018) %>%
  group_by(GRID5KM_ID, month, month_as_numeric) %>%
  summarise(
    DCRB_lbs = sum(DCRB_lbs_per_VMSlocation),
    DCRB_rev = sum(DCRB_rev_per_VMSlocation),
    DCRB_VMS_pings = n(),
    DCRB_Vessels = sum(DCRB_Vessels_per_VMSlocation),
    Unique_DCRB_Vessels = length(unique(as.character(drvid))),
    .groups = 'drop'
  )
glimpse(baseline_2014_2018)
sort(unique(baseline_2014_2018$month_as_numeric)) # TODO check completeness here, and # grid cells per month
write_rds(baseline_2014_2018, here::here('Confidential', 'data', 'processed', 'baseline_2014_2018.rds'))

# summarize baseline data (2017-2018) at monthly temporal grain and grid cell ID spatial grain
baseline_2017_2018 <- dcrb_vms_tix_analysis_TripInfo %>%
  filter(year >= 2017 & year <= 2018) %>%
  group_by(GRID5KM_ID, month, month_as_numeric) %>%
  summarise(
    DCRB_lbs = sum(DCRB_lbs_per_VMSlocation),
    DCRB_rev = sum(DCRB_rev_per_VMSlocation),
    DCRB_VMS_pings = n(),
    DCRB_Vessels = sum(DCRB_Vessels_per_VMSlocation),
    Unique_DCRB_Vessels = length(unique(as.character(drvid))),
    .groups = 'drop'
  )
glimpse(baseline_2017_2018)
sort(unique(baseline_2017_2018$month_as_numeric)) # TODO check completeness here, and # grid cells per month
write_rds(baseline_2017_2018, here::here('Confidential', 'data', 'processed', 'baseline_2017_2018.rds'))

# TODO join baselines into one dataframe, joined on grid ID and month

# summarize real-time data (2019-2023) at yearly and monthly temporal grain and grid cell ID spatial grain
realtime_2019_2023 <- dcrb_vms_tix_analysis_TripInfo %>%
  filter(year >= 2019 & year <= 2023) %>%
  group_by(GRID5KM_ID, year_month, year, month, month_as_numeric) %>%
  summarise(
    DCRB_lbs = sum(DCRB_lbs_per_VMSlocation),
    DCRB_rev = sum(DCRB_rev_per_VMSlocation),
    DCRB_VMS_pings = n(),
    DCRB_Vessels = sum(DCRB_Vessels_per_VMSlocation),
    Unique_DCRB_Vessels = length(unique(as.character(drvid))),
    .groups = 'drop'
  )
glimpse(realtime_2019_2023)
sort(unique(realtime_2019_2023$year_month)) # TODO check completeness here, and # grid cells per year_month
write_rds(realtime_2019_2023, here::here('Confidential', 'data', 'processed', 'realtime_2019_2023.rds'))

# TODO does this now need to be normalized? how so?
# TODO which metric should Heather be using for fishing effort? I assume normalized # pings...
```

## Old note from Jameal: Did not yet, but could summarise by yr, yr_month, etc

```{r}
#TODO explore these two summaries, I didn't touch this section

## code from Kelly for creating dfs for 1) drvid confidentiality (vessels_SPECIES) and 2) pings/grid cell/year with lbs and rev
#unique vessel ids by year
# load raw DCRB pings 2009-2023 (sub CHNK for chinook)
DCRB_vms_tix_daily_2009_2023_lbs_rev_per_geolocation_nodepthfilter <- readRDS("~/Documents/GitHub/VMS-pipeline/Confidential/processed/pipeline output/DCRB and CHNK 28May2024/DCRB_vms_tix_daily_2009_2023_lbs_rev_per_geolocation_nodepthfilter.rds")

vessels_DCRB <- DCRB_vms_tix_daily_2009_2023_lbs_rev_per_geolocation_nodepthfilter %>%
dplyr::select(GRID5KM_ID, year, drvid) %>%
distinct()

# save the df (sub CHNK for chinook_)
write_rds(vessels_DCRB,here::here('Confidential', 'processed', 'pipeline output', 'DCRB and CHNK 28May2024', 'vessels_4_confidentiality_DCRB.rds'))


## figuring out whether unique vessel ids are summed per year?
# load DCRB pings overlaid on 5km grid (sub CHNK for chinook)
DCRB_vms_tix_daily_2009_2023_lbs_rev_per_5kmgrid_nodepthfilter <- readRDS("~/Documents/GitHub/VMS-pipeline/Confidential/processed/pipeline output/DCRB and CHNK 28May2024/DCRB_vms_tix_daily_2009_2023_lbs_rev_per_5kmgrid_nodepthfilter.rds")

test_sum_DCRB <- DCRB_vms_tix_daily_2009_2023_lbs_rev_per_5kmgrid_nodepthfilter 

## create output table with unique vessels, target rev/lba and other rev/lbs, by year (sub CHNK for chinook)
pings_per_gridcell_DCRB <- test_sum_DCRB %>%
  group_by(GRID5KM_ID, year) %>%
  summarise(
    DCRB_lbs = sum(DCRB_lbs, na.rm = TRUE),
    DCRB_rev = sum(DCRB_rev, na.rm = TRUE),
    Num_DCRB_VMS_pings = n()
  )
    
# save the df
write_rds(pings_per_gridcell_DCRB,here::here('Confidential', 'processed', 'pipeline output', 'DCRB and CHNK 28May2024', 'pings_per_gridcell_DCRB.rds'))
```