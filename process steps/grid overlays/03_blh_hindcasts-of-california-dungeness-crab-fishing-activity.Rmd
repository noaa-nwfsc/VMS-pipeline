---
title: "Hindcasts of California Dungeness crab fishing activity, 2011-2023"
author: "Brooke Hawkins"
date: "`r Sys.Date()`"
output: html_document
---

## Purpose
* Integrate interpolated VMS and fish ticket data to produce time series, rasters, and maps of fishing activity, landed weight, and revenue.
Deliverable:
* Monthly maps of fishing activity; tables summarizing monthly fishing activity

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Prep data

```{r import-libraries}
library(here)
library(readr)
library(tidyverse)
library(sf)
library(rnaturalearth)
library(viridis)
```

I'm starting with one year and one season, I will extend to more years once I like the output format.

```{r load-data}
# load RDS of joined, cleaned, interpolated VMS and fish ticket data as a dataframe
vms_df <- read_rds(here('Confidential', 'processed', 'matched', 'interpolation', '2014_interpolated.rds'))

# load 5km grid shape file as a simple features object
grid_5km <- read_sf(here('GIS_layers', 'master_5km_grid_tmer.shp'))

# join VMS and fish ticket data to grid
vms_df <- vms_df %>%
  st_as_sf(coords = c('LON', 'LAT'), crs=4326) %>%
  st_transform(st_crs(grid_5km)) %>%
  st_join(grid_5km) %>%
  st_set_geometry(NULL)
```

Some commonly used acronyms in variable naming are:

* `dcrb` dungeness crab
* `rev` revenue
* `lbs` pounds
* `VMS` vessel monitoring system

```{r transform-data}
# define filters
target_rev <- "DCRB"         # revenue target
target_lbs <- "DCRB"         # landings target
state_agency_code <- "C"     # landings brought to California ports
min_depth <- 0               # minimum depth in meters
max_depth <- -150            # maximum depth in meters
min_speed <- 0               # minimum speed in m/s
max_speed <- 4.11556         # maximum speed in m/s (4.11556 m/s = 8 knots)
crab_year_start <- 11        # month defines start of crab year
crab_years <- c("2014_2015") # crab years to include
winter_months <- c("November", "December", "January", "February", "March") # determine Winter or Spring-Summer season

# transform data
dcrb_df <- vms_df %>%
  # add temporal columns
  mutate(
    year = lubridate::year(westcoastdate_notime),
    month = lubridate::month(westcoastdate_notime, label=TRUE, abbr=FALSE),
    month_numeric = month(westcoastdate_notime),
    year_month = paste0(lubridate::year(westcoastdate_notime),"_", substr(lubridate::ymd(westcoastdate_notime), 6, 7)),
    crab_year = ifelse(month_numeric >= crab_year_start, paste0(year, "_", 1+year), paste0(year-1, "_", year)),
    season = as.character(ifelse(month %in% winter_months, "Winter", "Spring-Summer")),
    week_of_year = week(westcoastdate_notime),
    day_of_year = yday(westcoastdate_notime)
  ) %>%
  # apply filters
  filter(TARGET_rev == target_rev | TARGET_lbs == target_lbs) %>%
  filter(agency_code == state_agency_code) %>%
  filter(NGDC_M <= min_depth & NGDC_M >= max_depth) %>% # TODO should this be for WM_NGDC_M instead?
  filter(avg_speed_recalc <= max_speed & avg_speed_recalc >= min_speed) %>% 
  filter(crab_year %in% crab_years) %>%
  # select columns
  dplyr::select(
    # identifiers
    Rec_ID,           # fish ticket ID
    VMS_RECNO,        # VMS ping ID
    drvid,            # vessel ID
    pacfin_port_code, # port ID
    port_group_code,  # port group ID
    GRID5KM_ID,       # grid cell ID
    # temporal fields
    westcoastdate,
    westcoastdate_notime,
    crab_year, 
    season,
    year,
    year_month,
    month, 
    month_numeric,
    week_of_year,
    day_of_year,
    # vessel length
    FINAL_LENGTH,
    # dungeness crab fields
    DCRB_lbs,
    DCRB_revenue
  )

# count total records, trips and years
n_records <- nrow(vms_df)
n_trips   <- n_distinct(vms_df$Rec_ID)
n_years   <- n_distinct(lubridate::year(vms_df$westcoastdate_notime))

# take a peek at the resulting dataframe
glimpse(dcrb_df)
```

The dungeness crab dataframe has `r n_records` records (interpolated VMS pings), `r n_trips` trips (fish tickets), across `r n_years` years.

```{r gridded-summary}
# summarize trip-level attributes
trip_df <- dcrb_df %>%
  group_by(Rec_ID) %>%
  summarise(trip_n_vms_records = n(),
            trip_start = min(westcoastdate),
            trip_end = max(westcoastdate))

# join trip-level attributes back to dungeness crab dataframe
dcrb_trip_df <- left_join(dcrb_df, trip_df, by="Rec_ID") %>%
  mutate(
    dcrb_lbs_per_vms_record     = DCRB_lbs / trip_n_vms_records,
    dcrb_rev_per_vms_record     = DCRB_revenue / trip_n_vms_records,
    dcrb_vessels_per_vms_record = 1 / trip_n_vms_records
  )

# summarize grid cell and month-level attributes
confidential_df <- dcrb_df %>%
  group_by(GRID5KM_ID, year_month) %>%
  summarise(n_unique_vessels = n_distinct(drvid),
            # set confidential_flag TRUE for confidential, FALSE for non-confidential
            confidential_flag = (n_distinct(drvid) < 3), .groups="keep") %>%
  ungroup()

# join grid cell and month-level attributes back to dungeness crab dataframe
dcrb_confidential_df <- dcrb_trip_df %>%
  left_join(confidential_df, by=join_by(GRID5KM_ID, year_month))

# create monthly gridded summary
dcrb_5km_summary_df <- dcrb_confidential_df %>%
  group_by(
    # grid cell ID, makes this a gridded summary
    GRID5KM_ID,
    # temporal columns, makes this a monthly summary
    year,
    crab_year,
    year_month,
    season,
    month,
    month_numeric
  ) %>%
  # sum landings, revenue; count unique vessels and VMS records; determine confidentiality filter
  summarise(
    dcrb_lbs = sum(dcrb_lbs_per_vms_record),
    dcrb_rev = sum(dcrb_rev_per_vms_record),
    n_vms_records = n(),
    n_unique_vessels = n_distinct(drvid),
    # set confidential_flag TRUE for confidential, FALSE for non-confidential
    confidential_flag = max(confidential_flag) == 1,
    .groups = "keep"
  ) %>% 
  ungroup()
```

## Create outputs

If a grid cell in a given month has < 3 unique vessels, it cannot be included in non-confidential maps summarizing the data.

```{r}
# set whether to use the non-confidential or confidential gridded summary for output
confidential_output_flag <- TRUE

if (confidential_output_flag) {
  # if confidential output is ok, then don't remove any VMS records
  dcrb_5km_output_df <- dcrb_5km_summary_df
} else {
  # if non-confidential output is needed, then remove any VMS records where the grid cell and month had < 3 unique vessels, where confidential_flag is FALSE
 dcrb_5km_output_df <- dcrb_5km_summary_df %>% filter(!confidential_flag)
}
```

Regardless of whether you're using confidential or non-confidential output, report how many VMS records are filtered out by the confidentiality flag.

```{r confidentiality-stats}
# calculate the % of VMS records dropped by confidentiality filter
numerator_drop_confidential <- sum(dcrb_confidential_df$confidential_flag)
denominator_drop_confidential <- dim(dcrb_confidential_df)[1]
percent_drop_confidential <- substr(as.character(numerator_drop_confidential / denominator_drop_confidential * 100), 1, 5)
```

The non-confidential data has `r numerator_drop_confidential` (`r percent_drop_confidential`%) fewer records (VMS pings), where grid cells had <3 unique vessels in a given month.

```{r tables}
# define columns and functions to summarize in table
colnames_vector <- c('n_vms_records')
function_vector <- c('length', 'min', 'mean', 'median', 'max', 'IQR')

# summarize in a for loop for columns in column name vector c_vector
summary_table <- rbind(
  summarise_at(dcrb_5km_output_df, colnames_vector, get(function_vector[1])),
  summarise_at(dcrb_5km_output_df, colnames_vector, get(function_vector[2])),
  summarise_at(dcrb_5km_output_df, colnames_vector, get(function_vector[3])),
  summarise_at(dcrb_5km_output_df, colnames_vector, get(function_vector[4])),
  summarise_at(dcrb_5km_output_df, colnames_vector, get(function_vector[5])),
  summarise_at(dcrb_5km_output_df, colnames_vector, get(function_vector[6]))
)

# reformat table
summary_table <- cbind(
  # add metric name as column
  metric = function_vector,
  summary_table
) %>% 
  # turn metric name into rowname
  column_to_rownames('metric') %>%
  # transpose result
  t()

# write result
write.csv(file=here("Confidential", "tables", "sample_summary_table.csv"), x=summary_table)

# see result
summary_table
```

```{r maps}
# create a log-10 transformed map, to apply to each month of data
#   data_sf: sf object
#   data_col: vector from data_sf to log-transform and map
#   log10_fill_range: range for the log-10 transformed fill of data_col vector
#   bbox: bounding box to use for map
#   title: map title
#   data_col_name: name of data_col vector, used to label map legend and name output PNG
#   png_suffix: optional string, used to name output PNG
#   background_sf: sf object
create_log10_map <- function (data_sf, data_col, bbox, log10_fill_range, title, data_col_name, png_suffix='', background_sf) {
  # create map
  map_output <- ggplot() +
    # plot background
    geom_sf(data=background_sf, fill='gray80') +
    # plot log-10 transformed data
    geom_sf(data=data_sf, aes(fill=log10(data_col))) +
    # label plot
    labs(title=title,
         fill=paste0("log10(", data_col_name, ") per 5x5 cell")) +
    # set bounding box
    xlim(bbox[1], bbox[3]) + ylim(bbox[2], bbox[4]) +
    # set fill color and legend limits
    scale_fill_viridis(limits=log10_fill_range) +
    # adjust labels and legend position
    theme(axis.text.x=element_text(angle=45, vjust=1, hjust=1),
          axis.ticks.x=element_blank(),
          axis.ticks.y=element_blank(),
          legend.position="bottom")
  # save the output map
  ggsave(filename=here("Confidential", "figures", paste0("map_log10_", 
                                                         data_col_name, 
                                                         png_suffix, 
                                                         ".png")))
  # return the output map
  return(map_output)
}

# load west coast states simple features object for background
west_coast_states <- rnaturalearth::ne_states(country='United States of America', returnclass='sf') %>% 
  filter(name %in% c('California','Oregon','Washington','Nevada')) %>% 
  st_transform(st_crs(grid_5km))

# join geometry from 5km grid to gridded fishing summary
dcrb_5km_output_sf <- dcrb_5km_output_df %>%
  left_join(grid_5km, by=join_by(GRID5KM_ID)) %>%
  st_as_sf()

# set bounding box
bbox <- st_bbox(dcrb_5km_output_sf)

# set limits for min and max fill for log-10 transformed data
log10_fill_range <- range(log10(dcrb_5km_output_sf$n_vms_records))

# get unique and ordered year, year_month and month from gridded fishing summary
month_df <- dcrb_5km_output_sf %>% 
  st_drop_geometry() %>% 
  select(year, year_month, month) %>% 
  unique() %>% 
  arrange(year_month)

# iterate over months
for (ym in month_df$year_month) {
  # print progress
  print(ym)
  # get title as a combination of year and month
  y <- month_df$year[which(month_df$year_month==ym)]
  m <- month_df$month[which(month_df$year_month==ym)]
  title <- paste(y, m)
  # filter data for given month
  ym_data_sf <- dcrb_5km_output_sf %>% filter(year_month == ym)
  # make and save map
  map_output <- create_log10_map(data_sf=ym_data_sf,
                                data_col=ym_data_sf$n_vms_records,
                                bbox=bbox,
                                log10_fill_range = log10_fill_range,
                                title=title,
                                data_col_name='n_vms_records',
                                png_suffix=ym,
                                background_sf=west_coast_states)
}
```
