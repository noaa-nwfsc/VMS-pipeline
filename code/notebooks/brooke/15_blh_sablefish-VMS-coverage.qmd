---
title: "15_blh_sablefish-VMS-coverage"
format:
  html:
    embed-resources: true
---

```{r setup}
#| include: false
library(tidyverse)
library(here)
```

I'm using cleaned fish tickets from step 1 of the VMS output.

```{r filters}
# filters for fish tickets
sector_codes <- c(
  "Catch Shares",
  "Catch Shares EM",
  "Limited Entry Sablefish",
  "OA Fixed Gear"
)

# filters for VMS
target_rev <- "SABL" # revenue target
target_lbs <- "SABL" # landings target
min_depth <- 0 # minimum depth in meters
max_depth <- -1500 # maximum depth in meters
min_speed <- 0 # minimum speed in m/s
max_speed <- 4.11556 # maximum speed in m/s (4.11556 m/s = 8 knots)
```

I'm starting with one year of data for now (2018, not chosen for any reason).

Based on the [PacFIN Comprehensive FT documentation](https://pacfin.psmfc.org/wp-content/uploads/2022/05/PacFIN_Comprehensive_Fish_Tickets.pdf), the FTID is:

* FISH_TICKET_ID (renamed Rec_ID in VMS pipeline): PacFIN assigned unique number for each fish ticket. (Source: PacFIN)
* FTID: Source agency fish ticket identifier. This number is unique within a
year and agency, but not necessarily across years or agencies. (Source: Agency)

I checked with Kayleigh how she determines if a ticket is a sablefish pot ticket or not, and it's by filtering with the sector codes and pot group gear code.

Based on our discussions around Michaela's BiOp code, I am using these sector codes:

* CS: "Catch Shares" or "Catch Shares EM"
* LE: "Limited Entry Sablefish"
* OA: "OA Fixed Gear"

```{r checks}
# load fish tickets
tickets <- read_rds(here(
  'Confidential',
  'processed_data',
  'processed_2025-05-20',
  'fish_tickets',
  'fishtix_withFTID_2018.rds'
))

# filter for sablefish pot tickets
sabl_tickets <- tickets %>%
  filter(
    FOS_GROUNDFISH_SECTOR_CODE %in% sector_codes,
    PACFIN_GROUP_GEAR_CODE == "POT"
  ) %>%
  select(
    Rec_ID,
    FTID,
    date,
    drvid,
    agency_code,
    FOS_GROUNDFISH_SECTOR_CODE,
    SABL_lbs,
    SABL_revenue
  ) %>%
  distinct() %>%
  rename(
    ticket_date = "date",
    sector = "FOS_GROUNDFISH_SECTOR_CODE",
    landings = "SABL_lbs",
    revenue = "SABL_revenue"
  )
```

This next section reads in WCGOP & EM data, which I got from Kayleigh and is stored in `Confidential/raw_data/wcgop`. (WCGOP & EM = West Coast Groundfish Observer Program & Electronic Monitoring, data shared in December 2024)

```{r wcgop}
# read in WCGOP/EM data
wcgop <- read_csv(here(
  'Confidential',
  'raw_data',
  'wcgop',
  'TRT_Sablefish_WCGOPEM_HaulData_2024-12-12.csv'
))
# filter for one year of data, and filter for pot
# split fish tickets from one haul record into separate fish ticket IDs
pot_wcgop <- wcgop %>%
  filter(YEAR == 2018 & gear == 'Pot') %>%
  select(FISH_TIX, sector) %>%
  mutate(FTID = str_split(FISH_TIX, ';')) %>%
  unnest(FTID) %>%
  select(-FISH_TIX) %>%
  distinct() %>%
  mutate(wcgop_rep = 1)

# check out shape of result
nrow(pot_wcgop)
pot_wcgop %>% group_by(sector) %>% summarise(n_distinct(FTID))

# drop sector before rejoining to tickets
pot_wcgop <- pot_wcgop %>% select(-sector)
```

```{r vms}
# read in VMS data
vms_df <- read_rds(here(
  'Confidential',
  'processed_data',
  'processed_2025-05-20',
  'interpolated',
  'interpolated_2018.rds'
)) %>%
  select(
    FTID,
    FOS_GROUNDFISH_SECTOR_CODE,
    SABL_lbs,
    SABL_revenue,
    TARGET_lbs,
    TARGET_rev,
    avg_speed_recalc,
    NGDC_M
  ) %>%
  distinct() %>%
  mutate(vms_rep = 1)

# check out shape of result
vms_df %>% group_by(FOS_GROUNDFISH_SECTOR_CODE) %>% summarise(n_distinct(FTID))

# add speed and depth filters, then check again
filtered_vms_df <- vms_df %>%
  filter(TARGET_rev == target_rev | TARGET_lbs == target_lbs) %>%
  filter(NGDC_M <= min_depth & NGDC_M >= max_depth) %>%
  filter(avg_speed_recalc <= max_speed & avg_speed_recalc >= min_speed)
filtered_vms_df %>%
  group_by(FOS_GROUNDFISH_SECTOR_CODE) %>%
  summarise(n_distinct(FTID))

# add groundfish sector filters, then check again
filtered_vms_df <- filtered_vms_df %>%
  filter(FOS_GROUNDFISH_SECTOR_CODE %in% sector_codes)
filtered_vms_df %>%
  group_by(FOS_GROUNDFISH_SECTOR_CODE) %>%
  summarise(n_distinct(FTID))
```

```{r join}

joined_df <- sabl_tickets %>%
  # join the three dataframes
  left_join(pot_wcgop, by = join_by(FTID == FTID)) %>%
  left_join(filtered_vms_df, by = join_by(FTID == FTID)) %>%
  # drop duplicate or unneeded columns
  select(-FOS_GROUNDFISH_SECTOR_CODE, -NGDC_M) %>%
  # combine catch shares into the same sector and create a coverage variable
  mutate(
    wcgop_rep = coalesce(wcgop_rep, 0),
    vms_rep = coalesce(vms_rep, 0),
    sector = ifelse(sector == "Catch Shares EM", "Catch Shares", sector),
    coverage = case_when(
      wcgop_rep + vms_rep == 2 ~ "both",
      wcgop_rep == 1 ~ "wcgop_only",
      vms_rep == 1 ~ "vms_only",
      .default = "neither"
    ),
    coverage_factor = factor(
      coverage,
      levels = c("neither", "wcgop_only", "vms_only", "both")
    )
  )

vis_df <- joined_df %>%
  group_by(sector, coverage_factor) %>%
  summarize(n_tickets = n_distinct(FTID)) %>%
  ungroup() %>%
  group_by(sector) %>%
  mutate(
    percentage = n_tickets / sum(n_tickets),
    label_y_pos = (cumsum(percentage)) - (percentage / 2)
  ) %>%
  ungroup()

vis_df %>%
  ggplot(aes(x = sector, y = n_tickets, fill = coverage_factor)) +
  geom_col(position = "fill")

vis_df %>%
  ggplot(aes(x = sector, y = n_tickets, fill = coverage_factor)) +
  geom_col()
```
