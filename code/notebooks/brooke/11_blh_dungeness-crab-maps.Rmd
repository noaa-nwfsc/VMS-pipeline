---
title: "11_blh_dungeness-crab-maps"
author: "Brooke Hawkins"
date: "`r Sys.Date()`"
output: html_document
---

# Set up

```{r, include=FALSE}
# start timer
start_timer <- proc.time()
```

## Focus: Maps

Make persistence maps from gridded output for one-sliders and monthly maps from gridded output for appendix.

```{r setup, include=FALSE}
# import libraries
library(tidyverse)
library(here)
library(sf)
library(rnaturalearth)
library(viridis)
library(magick)

# adjust ggplot theme
theme_replace(axis.text.x=element_text(angle=45, vjust=1, hjust=1),
              axis.ticks.x=element_blank(),
              axis.ticks.y=element_blank())
```

```{r create-output-directories}
# make hindcast output subdirectory, if doesn't yet exist
output_dir <- here('Confidential', 'hindcast_output', paste0("hindcast_output_", Sys.Date()))
if (!dir.exists(output_dir)) dir.create(output_dir)
```

Choose years, map regions, and whether maps should be confidential.

The current options for years are *2011-2023* and are filtered based on the VMS data.

The current options for map regions are filtered based on the grid:

-   *Washington*: Washington state
-   *Oregon*: Oregon state
-   *Northern California:* California state, Northern California RAMP area
-   *Central California*: California state, Central and San Francisco RAMP areas
-   *Southern California*: California state, Southern RAMP area

Setting the confidential flag to `TRUE` will include all data in the maps. Setting the flag to `FALSE` will filter out grid cells with less than three unique vessels per month before making the maps.

```{r}
# choose years, numeric vector
year_vector <- 2012:2013
# choose map regions, string vector
region_vector <- c('Washington', 'Oregon', 'Northern California', 'Central California')
# choose confidential or not
confidential_flag <- FALSE
```

# Data

## Load data

1.  Load the joined, cleaned, interpolated VMS and fish ticket data for specified years, which will be used to map fishing activity distribution.
2.  Load the spatial 5km grid, which will also be used to map fishing activity distribution.
3.  Load the inflation adjustment table, which will be used to adjust revenue for inflation.

Pre-requisite: Run the pipeline steps 1-6 (including interpolation) for calendar years 2011-2023 for DCRB. Run notebook 10, which creates the inflation adjustment table and output directories.

```{r load-data}
# iterate over years from the year_vector set at the top of the script to load VMS and fish ticket data
vms_df <- purrr::map(year_vector, function(y) {
  read_rds(here('Confidential', 'processed_data', 'processed_2025-03-19', 'interpolated', paste0('interpolated_', y, '.rds')))
}) %>% bind_rows()

# load 5km grid shape file
grid_5km <- read_sf(here('spatial_data', 'fivekm_grid_polys_shore_lamb.shp'))

# load inflation adjustment
fred_pcepi <- read.csv(file = here(output_dir, "tables", "inflation_pcepi.csv")) %>%
  mutate(year_month = date(year_month))
```

## Transform data

Transform the joined, cleaned, interpolated VMS and fish ticket data:

1.  Filter for dungeness crab related records, min/max depth and speed filters.
2.  Add temporal columns.
3.  Adjust revenue for inflation with data from FRED.
4.  Join spatial grid to VMS data, which is one of the slowest parts of the script.
5.  Filter grid to include only US EEZ and remove Puget Sound fishing.

Some commonly used acronyms for variable naming in the code include:

-   `dcrb` dungeness crab
-   `rev` revenue
-   `lbs` landings
-   `VMS` vessel monitoring system
-   `afi` adjusted for inflation

```{r transform-vms-data}
# define filters
target_rev <- "DCRB"         # revenue target
target_lbs <- "DCRB"         # landings target
min_depth <- 0               # minimum depth in meters
max_depth <- -150            # maximum depth in meters
min_speed <- 0               # minimum speed in m/s
max_speed <- 4.11556         # maximum speed in m/s (4.11556 m/s = 8 knots)
crab_year_start <- 11        # month defines start of crab year
winter_months <- c("November", "December", "January", "February", "March") # determine Winter or Spring-Summer season

# transform VMS and fish ticket data
dcrb_vms_df <- vms_df %>%
  # add temporal columns
  mutate(
    year_numeric = year(westcoastdate_notime),
    month_numeric = month(westcoastdate_notime),
    week_numeric = week(westcoastdate_notime),
    day_numeric = yday(westcoastdate_notime),
    month_factor = month(westcoastdate_notime, label = TRUE, abbr = FALSE),
    year_month_character = paste0(year(westcoastdate_notime),"_", substr(ymd(westcoastdate_notime), 6, 7)),
    crab_year_character = ifelse(month_numeric >= crab_year_start, 
                                 paste0(year_numeric, "_", 1+year_numeric),
                                 paste0(year_numeric-1, "_", year_numeric)),
    season_character = as.character(ifelse(month_factor %in% winter_months, "Winter", "Spring-Summer")),
    year_month_date = ym(year_month_character)
  ) %>%
  # apply VMS filters
  filter(TARGET_rev == target_rev | TARGET_lbs == target_lbs) %>%
  filter(NGDC_M <= min_depth & NGDC_M >= max_depth) %>%
  filter(avg_speed_recalc <= max_speed & avg_speed_recalc >= min_speed) %>% 
  # join inflation adjustment factor and adjust revenue
  left_join(fred_pcepi, by = join_by(year_month_date == year_month)) %>%
  mutate(DCRB_revenue_afi = DCRB_revenue * 100 / pcepi) %>%
  # select columns
  dplyr::select(
    # identifiers
    Rec_ID,           # fish ticket ID
    VMS_RECNO,        # VMS ping ID
    drvid,            # vessel ID
    pacfin_port_code, # port ID
    port_group_code,  # port group ID
    agency_code,      # state agency code
    # temporal fields
    westcoastdate,
    westcoastdate_notime,
    year_month_date,
    crab_year_character,
    year_month_character,
    month_factor,
    year_numeric,
    month_numeric,
    week_numeric,
    day_numeric,
    # vessel length
    FINAL_LENGTH,
    # inflation adjustment index
    pcepi,
    # dungeness crab fields
    DCRB_lbs,
    DCRB_revenue_afi,
    # spatial fields
    LAT,
    LON
  ) %>%
  # join 5km grid
  st_as_sf(coords = c('LON', 'LAT'), crs = 4326) %>%
  st_transform(st_crs(grid_5km)) %>%
  st_join(grid_5km) %>%
  st_set_geometry(NULL) %>%
  # apply grid filters 
  filter(EEZ == "USA") %>%
  filter(Salish_Sea == 0) %>%
  # add map region column to split maps later on
  mutate(map_region = case_when(
    STATE == "WA" ~ "Washington",
    STATE == "OR" ~ "Oregon",
    STATE == "CA" & RAMP_area == "Northern" ~ "Northern California",
    STATE == "CA" & RAMP_area %in% c("Central", "San Francisco") ~ "Central California",
    STATE == "CA" & RAMP_area == "Southern" ~ "Southern California",
    .default = "Other"
  )) %>%
  # drop some columns not currently in use, though these can be used later for joining to Chris Free's data
  select(-c("LL_EAST", "UL_EAST", "UR_EAST", "LR_EAST", "LL_NORTH", "UL_NORTH", "UR_NORTH", "LR_NORTH", "LL_LATITUD", "UL_LATITUD", "UR_LATITUD", "LR_LATITUD", "LL_LONGITU", "UL_LONGITU", "UR_LONGITU", "LR_LONGITU"))

# count total records, trips and years
n_records <- nrow(dcrb_vms_df)
n_trips   <- n_distinct(dcrb_vms_df$Rec_ID)
n_years   <- n_distinct(dcrb_vms_df$year_numeric)

# take a peek at the resulting dataframe
glimpse(dcrb_vms_df)
```

The dungeness crab VMS dataframe has `r n_records` records (interpolated VMS pings), `r n_trips` trips (fish tickets), across `r n_years` years.

```{r}
# clean up
remove(vms_df, n_records, n_trips, n_years)
```

Next, create a monthly gridded summary of fishing activity.

1.  Add trip-level attributes:

-   `trip_n_vms_records`: the number of interpolated VMS records associated with a fishing trip (fish ticket)

2.  Add VMS record attributes, calculated using the trip-level attribute:

-   `dcrb_lbs_per_vms_record`: the total landings for a fishing trip, divided by the number of VMS records associated with that trip (e.g. a fish ticket with 1200 lbs landed and 20 VMS records would have 60 lbs per VMS record)
-   `dcrb_rev_per_vms_record`: the total revenue for a fishing trip, divided by the number of VMS records associated with that trip (e.g. a fish ticket with \$4000 revenue and 20 VMS pings would have \$200 revenue per VMS record)

3.  Summarize fishing activity at a monthly gridded level:

-   `dcrb_lbs`: the total landings per VMS record in a given grid cell in a given month
-   `dcrb_rev`: the total revenue per VMS record in a given grid cell in a given month
-   `n_vms_records`: the number of VMS records in a given grid cell in a given month
-   `n_unique_vessels`: the number of unique vessels in a given grid cell in a given month
-   `remove_for_confidentiality`: determines whether the grid cell month has \<3 unique vessels; in which case, the data in this grid cell and month needs to be excluded from non-confidential reports

4.  Optionally filter for non-confidentiality, depending on `confidential_flag` set at the top of the script.

```{r gridded-summary}
# count records per trip (fish ticket)
trip_df <- dcrb_vms_df %>%
  group_by(Rec_ID) %>%
  summarise(trip_n_vms_records = n())

# create monthly gridded summary
dcrb_5km_monthly_df <- dcrb_vms_df %>% 
  # join records per trip to VMS data
  left_join(trip_df, by = "Rec_ID") %>%
  # attribute landings and revenue to each VMS record
  mutate(
    dcrb_lbs_per_vms_record = DCRB_lbs / trip_n_vms_records,
    dcrb_rev_per_vms_record = DCRB_revenue_afi / trip_n_vms_records
  ) %>%
  # create monthly gridded summary
  group_by(
    # grid cell ID, makes this a gridded summary
    GRID5KM_ID,
    # state and map_region, used to facet maps later on
    STATE,
    map_region,
    # temporal columns, makes this a monthly summary
    crab_year_character,
    year_numeric,
    year_month_character,
    year_month_date,
    month_factor,
    month_numeric
  ) %>%
  # sum landings and revenue, count VMS records and unique vessels
  summarise(
    dcrb_lbs = sum(dcrb_lbs_per_vms_record),
    dcrb_rev = sum(dcrb_rev_per_vms_record),
    n_vms_records = n(),
    log_10_n_vms_records = log10(n_vms_records),
    n_unique_vessels = n_distinct(drvid),
    .groups = "drop"
  ) %>% 
  # remove for confidentiality if a grid cell and month has < 3 distinct vessels
  mutate(remove_for_confidentiality = n_unique_vessels < 3)

# if confidential flag is set to false, then filter out records that should be removed for confidentiality
if (!confidential_flag) {
  dcrb_5km_monthly_df <- dcrb_5km_monthly_df %>% filter(!remove_for_confidentiality)
}

# write monthly gridded summary, specifying whether output is confidential
if (confidential_flag) {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_monthly_confidential_df.csv"),
    x = dcrb_5km_monthly_df, 
    row.names = FALSE
  )
} else {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_monthly_nonconfidential_df.csv"),
    x = dcrb_5km_monthly_df, 
    row.names = FALSE
  )
}
```

# Plots

Create fishing activity maps, based on the gridded summary above. This is one of the slowest parts of the script.

```{r background-map}
# set west coast as background map
west_coast_states <- rnaturalearth::ne_states(country = 'United States of America', returnclass = 'sf') %>% 
  filter(name %in% c('California', 'Oregon', 'Washington', 'Nevada')) %>% 
  st_transform(st_crs(grid_5km))

# fishing activity map
fishing_map <- function(data_sf, fill_var, fill_range, background_sf, map_bbox, title_label, fill_label, png_name) {
  map_output <- ggplot() +
    geom_sf(data = background_sf, fill = 'gray80') +
    geom_sf(data = data_sf, aes(fill = get(fill_var)), lwd = 0) +
    labs(title = title_label, fill = paste(fill_label, "per 5x5 cell")) +
    xlim(map_bbox[1], map_bbox[3]) + ylim(map_bbox[2], map_bbox[4]) +
    scale_fill_viridis(limits = fill_range) +
    theme(legend.position = "bottom")
  ggsave(filename = png_name, create.dir = TRUE)
  return(map_output)
}
```

## Coastal maps

### Persistence

#### Simple

Create a simple persistence map, which will visualize the number of years with any amount of fishing activity in a given grid cell.

```{r persistence-maps-coastal-simple}
# simple persistence summary: for how many crab years did the grid cell include fishing activity?
dcrb_5km_persistence_simple_df <- dcrb_5km_monthly_df %>% 
  group_by(GRID5KM_ID, STATE) %>% 
  summarise(crab_years_with_fishing_activity = n_distinct(crab_year_character))

# write simple persistence summary, specifying whether output is confidential
if (confidential_flag) {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_persistence_simple_confidential_df.csv"),
    x = dcrb_5km_persistence_simple_df, 
    row.names = FALSE
  )
} else {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_persistence_simple_nonconfidential_df.csv"),
    x = dcrb_5km_persistence_simple_df, 
    row.names = FALSE
  )
}

# join geometry from 5km grid to gridded fishing summary
dcrb_5km_persistence_simple_sf <- dcrb_5km_persistence_simple_df %>%
  left_join(grid_5km, by = join_by(GRID5KM_ID)) %>%
  st_as_sf()

# set map directory name, specifying whether output is confidential
if (confidential_flag) {
  png_name = here(output_dir, "maps_confidential", "persistence", "all", paste0("simple_persistence_all_time.png"))
} else {
  png_name = here(output_dir, "maps_nonconfidential", "persistence", "all", paste0("simple_persistence_all_time.png"))
}

# fishing activity map - whole time series
simple_persistence_map <- fishing_map(
  data_sf = dcrb_5km_persistence_simple_sf,
  fill_var = "crab_years_with_fishing_activity",
  fill_range = range(dcrb_5km_persistence_simple_sf$crab_years_with_fishing_activity),
  background_sf = west_coast_states,
  map_bbox = st_bbox(dcrb_5km_persistence_simple_sf),
  title_label = paste0("Persistence Map (Simple), ", min(year_vector), "-", max(year_vector)),
  fill_label = "Crab Years with Fishing Activity",
  png_name = png_name
)
```

#### Ranked

Create a ranked persistence map, which will visualize the top `persistence_threshold`% of fishing activity based on the number of interpolated pings for a given year in a given grid cell. There is some complicated logic in here, see `12_blh_example-ranked-persistence-map.Rmd` for a hypothetical example.

The logic here assumes that the number of pings is a positive non-zero integer (no fractions, no negative values). If that changes, then update the dense rank and case when statements accordingly.

```{r persistence-maps-coastal-ranked}
# set a threshold of fishing activity for a given year you'd like to reach
persistence_threshold <- 0.75

# calculate pings per crab year, rounding up if the result is a decimal
dcrb_yearly_df <- dcrb_5km_monthly_df %>%
  group_by(crab_year_character) %>%
  summarise(year_n_vms_records = sum(n_vms_records),
            year_cutoff_n_vms_records = ceiling(year_n_vms_records * persistence_threshold))

# calculate total pings per grid cell per crab year (drops month, and doesn't include revenue or landings for now)
dcrb_5km_yearly_df <- dcrb_5km_monthly_df %>%
  group_by(GRID5KM_ID, STATE, crab_year_character) %>%
  summarise(n_vms_records = sum(n_vms_records))

# sort grid cells based on # pings per crab year and determine whether to include in persistence map
dcrb_5km_persistence_ranked_interim_df <- dcrb_5km_yearly_df %>% 
  left_join(dcrb_yearly_df, by = 'crab_year_character') %>% 
  group_by(crab_year_character) %>%
  arrange(crab_year_character, dense_rank(n_vms_records * -1)) %>%
  mutate(cumulative_n_vms_records = cumsum(n_vms_records),
         include = (cumulative_n_vms_records <= year_cutoff_n_vms_records |
                      (cumulative_n_vms_records > year_cutoff_n_vms_records & lag(cumulative_n_vms_records < year_cutoff_n_vms_records))))

# write intermediate output, specifying whether output is confidential
if (confidential_flag) {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_persistence_ranked_interim_confidential_df.csv"),
    x = dcrb_5km_persistence_ranked_interim_df, 
    row.names = FALSE
  )
} else {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_persistence_ranked_interim_nonconfidential_df.csv"),
    x = dcrb_5km_persistence_ranked_interim_df, 
    row.names = FALSE
  )
}

# ranked persistence summary: for how many crab years did the grid cell contribute to 75% of the fishing activity?
dcrb_5km_persistence_ranked_df <- dcrb_5km_persistence_ranked_interim_df %>% 
  filter(include) %>%
  group_by(GRID5KM_ID) %>% 
  summarise(crab_years_with_fishing_activity = n_distinct(crab_year_character))

# write ranked output, specifying whether output is confidential
if (confidential_flag) {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_persistence_ranked_confidential_df.csv"),
    x = dcrb_5km_persistence_ranked_df, 
    row.names = FALSE
  )
} else {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_persistence_ranked_nonconfidential_df.csv"),
    x = dcrb_5km_persistence_ranked_df, 
    row.names = FALSE
  )
}

# join geometry from 5km grid to gridded fishing summary
dcrb_5km_persistence_ranked_sf <- dcrb_5km_persistence_ranked_df %>%
  left_join(grid_5km, by = join_by(GRID5KM_ID)) %>%
  st_as_sf()

# set map directory name, specifying whether output is confidential
if (confidential_flag) {
  png_name = here(output_dir, "maps_confidential", "persistence", "all", paste0("ranked_persistence_all_time_", persistence_threshold * 100, ".png"))
} else {
  png_name = here(output_dir, "maps_nonconfidential", "persistence", "all", paste0("ranked_persistence_all_time_", persistence_threshold * 100, ".png"))
}

# fishing activity map - whole time series
ranked_persistence_map <- fishing_map(
  data_sf = dcrb_5km_persistence_ranked_sf,
  fill_var = "crab_years_with_fishing_activity",
  fill_range = range(dcrb_5km_persistence_ranked_sf$crab_years_with_fishing_activity),
  background_sf = west_coast_states,
  map_bbox = st_bbox(dcrb_5km_persistence_ranked_sf),
  title_label = paste0("Persistence Map (", persistence_threshold * 100, "% Effort), ", min(year_vector), "-", max(year_vector)),
  fill_label = "Crab Years with Fishing Activity",
  png_name = png_name
)
```

### Monthly

```{r monthly-maps-coastal}
# join geometry from 5km grid to gridded fishing summary
dcrb_5km_monthly_sf <- dcrb_5km_monthly_df %>%
  left_join(grid_5km, by = join_by(GRID5KM_ID, STATE)) %>%
  st_as_sf()

# set bounding box across whole time frame (not just one month)
coast_bbox <- st_bbox(dcrb_5km_monthly_sf)

# set limits for min and max fill for # VMS pings across whole time frame (not just one month)
log_10_n_vms_records_fill_range <- range(dcrb_5km_monthly_sf$log_10_n_vms_records)

# get unique years and months from gridded fishing summary
year_month_vector <- sort(unique(dcrb_5km_monthly_df$year_month_character))

# set map directory name, specifying whether output is confidential
if (confidential_flag) {
  map_subdir = here(output_dir, "maps_confidential", "monthly", "all")
} else {
  map_subdir = here(output_dir, "maps_nonconfidential", "monthly", "all")
}

# iterate over months
for (ym in year_month_vector) {
  # filter data for given month
  ym_data_sf <- dcrb_5km_monthly_sf %>% filter(year_month_character == ym)
  # make and save map of # VMS pings for each month
  vms_map <- fishing_map(
    data_sf = ym_data_sf,
    fill_var = "log_10_n_vms_records",
    fill_range = log_10_n_vms_records_fill_range,
    background_sf = west_coast_states,
    map_bbox = coast_bbox,
    title_label = paste(substr(ym, 1, 4), month.name[as.numeric(substr(ym, 6, 7))]),
    fill_label = "Log-10 Interpolated VMS Records",
    png_name = here(map_subdir, paste0("log_10_n_vms_records_", ym, ".png"))
  )
}
```

## State maps

### Persistence

#### Ranked

```{r persistence-maps-state-ranked}
# calculate pings per crab year per state, rounding up if the result is a decimal
dcrb_yearly_state_df <- dcrb_5km_monthly_df %>%
  group_by(crab_year_character, STATE) %>%
  summarise(year_n_vms_records = sum(n_vms_records),
            year_cutoff_n_vms_records = ceiling(year_n_vms_records * persistence_threshold))

# sort grid cells based on # pings per crab year and determine whether to include in persistence map
dcrb_5km_persistence_ranked_interim_state_df <- dcrb_5km_yearly_df %>% 
  left_join(dcrb_yearly_state_df, by = c('crab_year_character', 'STATE')) %>% 
  group_by(crab_year_character, STATE) %>%
  arrange(crab_year_character, STATE, dense_rank(n_vms_records * -1)) %>%
  mutate(cumulative_n_vms_records = cumsum(n_vms_records),
         include = (cumulative_n_vms_records <= year_cutoff_n_vms_records |
                      (cumulative_n_vms_records > year_cutoff_n_vms_records & lag(cumulative_n_vms_records < year_cutoff_n_vms_records))))

# write intermediate output, specifying whether output is confidential
if (confidential_flag) {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_persistence_ranked_interim_state_confidential_df.csv"),
    x = dcrb_5km_persistence_ranked_interim_state_df, 
    row.names = FALSE
  )
} else {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_persistence_ranked_interim_state_nonconfidential_df.csv"),
    x = dcrb_5km_persistence_ranked_interim_state_df, 
    row.names = FALSE
  )
}

# ranked persistence summary: for how many crab years did the grid cell contribute to 75% of the fishing activity?
dcrb_5km_persistence_ranked_state_df <- dcrb_5km_persistence_ranked_interim_state_df %>% 
  filter(include) %>%
  group_by(GRID5KM_ID, STATE) %>% 
  summarise(crab_years_with_fishing_activity = n_distinct(crab_year_character))

# write ranked output, specifying whether output is confidential
if (confidential_flag) {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_persistence_ranked_state_confidential_df.csv"),
    x = dcrb_5km_persistence_ranked_state_df, 
    row.names = FALSE
  )
} else {
  write.csv(
    file = here(output_dir, "tables", "dcrb_5km_persistence_ranked_state_nonconfidential_df.csv"),
    x = dcrb_5km_persistence_ranked_state_df, 
    row.names = FALSE
  )
}

# join geometry from 5km grid to gridded fishing summary
dcrb_5km_persistence_ranked_state_sf <- dcrb_5km_persistence_ranked_state_df %>%
  left_join(grid_5km, by = join_by(GRID5KM_ID, STATE)) %>%
  st_as_sf()

# get unique states from gridded fishing summary
state_vector <- sort(unique(dcrb_5km_persistence_ranked_state_sf$STATE))

# set map directory name, specifying whether output is confidential
if (confidential_flag) {
  map_subdir = here(output_dir, "maps_confidential", "persistence")
} else {
  map_subdir = here(output_dir, "maps_nonconfidential", "persistence")
}

for (s in state_vector) {
  # filter data and set bounding box for state
  state_sf <- dcrb_5km_persistence_ranked_state_sf %>% filter(STATE == s)
  state_bbox <- st_bbox(state_sf)
  
  # fishing activity map - whole time series
  ranked_persistence_map <- fishing_map(
    data_sf = state_sf,
    fill_var = "crab_years_with_fishing_activity",
    fill_range = range(state_sf$crab_years_with_fishing_activity),
    background_sf = west_coast_states,
    map_bbox = st_bbox(state_sf),
    title_label = paste0("Persistence Map (", persistence_threshold * 100, "% Effort), ", min(year_vector), "-", max(year_vector)),
    fill_label = "Crab Years with Fishing Activity",
    png_name = here(map_subdir, s, paste0("ranked_persistence_all_time_", persistence_threshold * 100, ".png"))
  )
}
```

### Monthly

#### PNGs

```{r monthly-maps-state}
# set map directory name, specifying whether output is confidential
if (confidential_flag) {
  map_subdir = here(output_dir, "maps_confidential", "monthly")
} else {
  map_subdir = here(output_dir, "maps_nonconfidential", "monthly")
}

# iterate over map regions from the region_vector set at the top of the script
for (r in region_vector) {
  # filter data and set bounding box for state
  region_sf <- dcrb_5km_monthly_sf %>% filter(map_region == r)
  region_bbox <- st_bbox(region_sf)
  
  # set limits for min and max fill for # VMS pings across region for whole time frame (not just one month)
  region_fill_range <- range(region_sf$log_10_n_vms_records)

  # iterate over months
  for (y in year_vector) {
    for (m in 1:12) {
      
      # filter data for year month
      ym_data_sf <- region_sf %>% 
        filter(year_numeric == y) %>%
        filter(month_numeric == m)
      
      # get png directory name
      png_dir_name <- here(map_subdir, r)
      
      # create file name, adding "blank" to the file name if there's no data
      if (nrow(ym_data_sf) > 0) {
        png_name <- here(
          png_dir_name, 
          paste0("log_10_n_vms_records_", y, "_", ifelse(nchar(m) == 1, paste0("0", m), m), ".png")
        )
      } else {
        png_name <- here(
          png_dir_name, 
          paste0("log_10_n_vms_records_", y, "_", ifelse(nchar(m) == 1, paste0("0", m), m), "_blank.png")
        )
      }
      
      # make png
      vms_map <- fishing_map(
        data_sf = ym_data_sf,
        fill_var = "log_10_n_vms_records",
        fill_range = region_fill_range,
        background_sf = west_coast_states,
        map_bbox = region_bbox,
        title_label = paste(y, month.name[m]),
        fill_label = "Log-10 Interpolated VMS Records",
        png_name = png_name
      )
    }
  }
}

rm(r, y, m)
```

#### GIFs

For each region, combine maps into animated gif.

```{r gif-function}
# function to combine fishing activity maps in map_directory into an animation.gif in the same folder
fishing_activity_gif <- function (map_directory) {
  # get list of files in the map directory
  png_list <- list.files(map_directory)
  # read in all images
  image_list <- lapply(here(map_directory, png_list), image_read)
  # join and animate images
  image_gif <- image_animate(image_join(image_list), fps = 2)
  # write GIF
  image_write(image = image_gif, path = here(map_directory, "animation.gif"))
  # return GIF
  return(image_gif)
}
```

```{r monthly-map-state-gifs}
# iterate over map regions from the region_vector set at the top of the script
for (r in region_vector) {
  fishing_activity_gif(here(map_subdir, r))
}
```

```{r, include=FALSE}
# end timer
end_timer <- proc.time()
total_timer <- end_timer - start_timer

# write CSV with chosen parameters and runtime
log_df <- tibble(
  variable = c('year_vector', 'region_vector', 'confidential_flag', 'end_time', 'run_time_minutes'),
 value = c(
   paste(year_vector, collapse = ", "), 
   paste(region_vector, collapse = ", "), 
   confidential_flag,
   end_time = format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z"),
   run_time = round(total_timer[3]/60, 2)
 )
)
write.csv(file = here(output_dir, "map_log.csv"), x = log_df, row.names = FALSE)
```

This script took `r round(total_timer[3]/60, 2)` minutes to run.