---
title: "11_blh_dungeness-crab-maps"
author: "Brooke Hawkins"
date: "`r Sys.Date()`"
output: html_document
---

# Set up

```{r, include=FALSE}
# start timer
start_timer <- proc.time()
```

## Focus: Maps

Make persistence maps from gridded output for one-sliders and monthly maps from gridded output for appendix.

```{r setup, include=FALSE}
# import libraries
library(tidyverse)
library(here)
library(sf)
library(rnaturalearth)
library(viridis)

# adjust ggplot theme
theme_replace(axis.text.x=element_text(angle=45, vjust=1, hjust=1),
              axis.ticks.x=element_blank(),
              axis.ticks.y=element_blank())
```

```{r create-output-directories}
# create hindcast output subdirectory name based on system date
output_subdir_name <- paste0("hindcast_output_", Sys.Date())

# make hindcast output subdirectory, if doesn't yet exist
output_subdir <- here('Confidential', 'hindcast_output', output_subdir_name)
if (!dir.exists(output_subdir)) dir.create(output_subdir)
```

# Data

## Load data

1. Load the joined, cleaned, interpolated VMS and fish ticket data for specified years, which will be used to map fishing activity distribution. 
2. Load the spatial 5km grid, which will also be used to map fishing activity distribution.
3. Load the inflation adjustment table, which will be used to adjust revenue for inflation.

Pre-requisite: Run the pipeline steps 1-6 (including interpolation) for calendar years 2011-2023 for DCRB. Run notebook 10, which creates the inflation adjustment table and output directories.

```{r load-data}
# choose years of data to load
load_years <- 2011:2023

# load VMS and fish ticket data
vms_df <- purrr::map(load_years, function(ly) {
  read_rds(here('Confidential', 'processed_data', 'processed_2025-03-19', 'interpolated', paste0('interpolated_', ly, '.rds')))
}) %>% bind_rows()

# load 5km grid shape file
grid_5km <- read_sf(here('spatial_data', 'master_5km_grid_tmer.shp'))

# load inflation adjustment
gdp_defl <- read.csv(file = here("Confidential", "hindcast_output", output_subdir_name, "tables", "inflation_adjustment.csv"))
```

## Transform data

Transform the joined, cleaned, interpolated VMS and fish ticket data:

1. Filter for dungeness crab related records, California landings, min/max depth and speed filters.
2. Add temporal columns.
3. Adjust revenue for inflation with data from FRED.
4. Join spatial grid to VMS data, which is one of the slowest parts of the script.

Some commonly used acronyms for variable naming in the code include:

* `dcrb` dungeness crab
* `rev` revenue
* `lbs` landings
* `VMS` vessel monitoring system
* `afi` adjusted for inflation

```{r transform-vms-data}
# define filters
target_rev <- "DCRB"         # revenue target
target_lbs <- "DCRB"         # landings target
min_depth <- 0               # minimum depth in meters
max_depth <- -150            # maximum depth in meters
min_speed <- 0               # minimum speed in m/s
max_speed <- 4.11556         # maximum speed in m/s (4.11556 m/s = 8 knots)
crab_year_start <- 11        # month defines start of crab year
winter_months <- c("November", "December", "January", "February", "March") # determine Winter or Spring-Summer season

# transform VMS and fish ticket data
dcrb_vms_df <- vms_df %>%
  # add temporal columns
  mutate(
    year_numeric = year(westcoastdate_notime),
    month_numeric = month(westcoastdate_notime),
    week_numeric = week(westcoastdate_notime),
    day_numeric = yday(westcoastdate_notime),
    month_factor = month(westcoastdate_notime, label = TRUE, abbr = FALSE),
    year_month_character = paste0(year(westcoastdate_notime),"_", substr(ymd(westcoastdate_notime), 6, 7)),
    crab_year_character = ifelse(month_numeric >= crab_year_start, 
                                 paste0(year_numeric, "_", 1+year_numeric),
                                 paste0(year_numeric-1, "_", year_numeric)),
    season_character = as.character(ifelse(month_factor %in% winter_months, "Winter", "Spring-Summer")),
    year_month_date = ym(year_month_character)
  ) %>%
  # apply filters
  filter(TARGET_rev == target_rev | TARGET_lbs == target_lbs) %>%
  filter(NGDC_M <= min_depth & NGDC_M >= max_depth) %>%
  filter(avg_speed_recalc <= max_speed & avg_speed_recalc >= min_speed) %>% 
  # join inflation adjustment factor and adjust revenue
  left_join(gdp_defl, by = join_by(year_numeric == year)) %>%
  mutate(DCRB_revenue_afi = DCRB_revenue / inflation_adjustment_factor) %>%
  # select columns
  dplyr::select(
    # identifiers
    Rec_ID,           # fish ticket ID
    VMS_RECNO,        # VMS ping ID
    drvid,            # vessel ID
    pacfin_port_code, # port ID
    port_group_code,  # port group ID
    agency_code,      # state agency code
    # temporal fields
    westcoastdate,
    westcoastdate_notime,
    year_month_date,
    crab_year_character,
    year_month_character,
    month_factor,
    year_numeric,
    month_numeric,
    week_numeric,
    day_numeric,
    # vessel length
    FINAL_LENGTH,
    # dungeness crab fields
    DCRB_lbs,
    DCRB_revenue_afi,
    # spatial fields
    LAT,
    LON
  ) %>%
  # join 5km grid
  st_as_sf(coords = c('LON', 'LAT'), crs = 4326) %>%
  st_transform(st_crs(grid_5km)) %>%
  st_join(grid_5km) %>%
  st_set_geometry(NULL)

# count total records, trips and years
n_records <- nrow(dcrb_vms_df)
n_trips   <- n_distinct(dcrb_vms_df$Rec_ID)
n_years   <- n_distinct(dcrb_vms_df$year_numeric)

# take a peek at the resulting dataframe
glimpse(dcrb_vms_df)
```

The dungeness crab VMS dataframe has `r n_records` records (interpolated VMS pings), `r n_trips` trips (fish tickets), across `r n_years` years.

```{r}
# clean up
remove(vms_df, n_records, n_trips, n_years)
```

Next, create a monthly gridded summary of fishing activity. 

1. Add trip-level attributes:

* `trip_n_vms_records`: the number of interpolated VMS records associated with a fishing trip (fish ticket)

2. Add VMS record attributes, calculated using the trip-level attribute:

* `dcrb_lbs_per_vms_record`: the total landings for a fishing trip, divided by the number of VMS records associated with that trip (e.g. a fish ticket with 1200 lbs landed and 20 VMS records would have 60 lbs per VMS record)
* `dcrb_rev_per_vms_record`: the total revenue for a fishing trip, divided by the number of VMS records associated with that trip (e.g. a fish ticket with $4000 revenue and 20 VMS pings would have \$200 revenue per VMS record)

3. Summarize fishing activity at a monthly gridded level:

* `dcrb_lbs`: the total landings per VMS record in a given grid cell in a given month
* `dcrb_rev`: the total revenue per VMS record in a given grid cell in a given month
* `n_vms_records`: the number of VMS records in a given grid cell in a given month
* `n_unique_vessels`: the number of unique vessels in a given grid cell in a given month
* `confidential_flag`: determines whether the grid cell month has <3 unique vessels; in which case, the data in this grid cell and month needs to be excluded from non-confidential reports

```{r gridded-summary}
# count records per trip (fish ticket)
trip_df <- dcrb_vms_df %>%
  group_by(Rec_ID) %>%
  summarise(trip_n_vms_records = n())

# create monthly gridded summary, based on 
dcrb_5km_monthly_df <- dcrb_vms_df %>% 
  # join records per trip to VMS data
  left_join(trip_df, by = "Rec_ID") %>%
  # attribute landings and revenue to each VMS record
  mutate(
    dcrb_lbs_per_vms_record = DCRB_lbs / trip_n_vms_records,
    dcrb_rev_per_vms_record = DCRB_revenue_afi / trip_n_vms_records
  ) %>%
  # create monthly gridded summary
  group_by(
    # grid cell ID, makes this a gridded summary
    GRID5KM_ID,
    # temporal columns, makes this a monthly summary
    crab_year_character,
    year_numeric,
    year_month_character,
    year_month_date,
    month_factor,
    month_numeric
  ) %>%
  # sum landings and revenue, count VMS records and unique vessels
  summarise(
    dcrb_lbs = sum(dcrb_lbs_per_vms_record),
    dcrb_rev = sum(dcrb_rev_per_vms_record),
    n_vms_records = n(),
    log_10_n_vms_records = log10(n_vms_records),
    n_unique_vessels = n_distinct(drvid),
    .groups = "drop"
  ) %>% 
  # remove for confidentiality if a grid cell and month has < 3 distinct vessels
  mutate(remove_for_confidentiality = n_unique_vessels < 3)

# write monthly gridded summary
write.csv(file = here("Confidential", "hindcast_output", output_subdir_name, "tables", "dcrb_5km_monthly_df.csv"), x = dcrb_5km_monthly_df)
```

# Plots

Create monthly fishing activity maps, based on the gridded summary above. This is one of the slowest parts of the script.

## Coastal maps

```{r coastal-maps}
# fishing activity map
fishing_map <- function(data_sf, fill_var, fill_range, background_sf, map_bbox, title_label, fill_label, png_name) {
  map_output <- ggplot() +
    geom_sf(data = background_sf, fill = 'gray80') +
    geom_sf(data = data_sf, aes(fill = get(fill_var)), lwd = 0) +
    labs(title = title_label, fill = paste(fill_label, "per 5x5 cell")) +
    xlim(map_bbox[1], map_bbox[3]) + ylim(map_bbox[2], map_bbox[4]) +
    scale_fill_viridis(limits = fill_range) +
    theme(legend.position = "bottom")
  ggsave(filename = png_name)
  return(map_output)
}

# set west coast as background map
west_coast_states <- rnaturalearth::ne_states(country = 'United States of America', returnclass = 'sf') %>% 
  filter(name %in% c('California', 'Oregon', 'Washington', 'Nevada')) %>% 
  st_transform(st_crs(grid_5km))

# join geometry from 5km grid to gridded fishing summary
dcrb_5km_monthly_sf <- dcrb_5km_monthly_df %>%
  left_join(grid_5km, by = join_by(GRID5KM_ID)) %>%
  st_as_sf()

# set bounding box across whole time frame (not just one month)
coast_bbox <- st_bbox(dcrb_5km_monthly_sf)

# set limits for min and max fill for # VMS pings across whole time frame (not just one month)
log_10_n_vms_records_fill_range <- range(dcrb_5km_monthly_sf$log_10_n_vms_records)

# get unique years and months from gridded fishing summary
year_month_vector <- sort(unique(dcrb_5km_monthly_df$year_month_character))

# iterate over months
for (ym in year_month_vector) {
  # filter data for given month
  ym_data_sf <- dcrb_5km_monthly_sf %>% filter(year_month_character == ym)
  # make and save map of # VMS pings for each month
  vms_map <- fishing_map(
    data_sf = ym_data_sf,
    fill_var = "log_10_n_vms_records",
    fill_range = log_10_n_vms_records_fill_range,
    background_sf = west_coast_states,
    map_bbox = coast_bbox,
    title_label = paste(substr(ym, 1, 4), month.name[as.numeric(substr(ym, 6, 7))]),
    fill_label = "Log-10 Interpolated VMS Records",
    png_name = here("Confidential", "hindcast_output",  output_subdir_name, "maps/monthly/all", paste0("log_10_n_vms_records_", ym, ".png"))
  )
}
```

## State maps

```{r state-maps}
# get unique states from gridded fishing summary
state_vector <- sort(unique(dcrb_5km_monthly_sf$STATE))

for (s in state_vector) {
  # filter data and set bounding box for state
  state_sf <- dcrb_5km_monthly_sf %>% filter(STATE == s)
  state_bbox <- st_bbox(state_sf)
  
  # set limits for min and max fill for # VMS pings across whole time frame (not just one month)
  state_fill_range <- range(state_sf$log_10_n_vms_records)
  
  # get unique years and months from gridded fishing summary
  state_year_month_vector <- sort(unique(state_sf$year_month_character))
  
  # iterate over months
  for (ym in state_year_month_vector) {
    # filter data for given month
    ym_data_sf <- state_sf %>% filter(year_month_character == ym) 
    # make and save map of # VMS pings for each month
    vms_map <- fishing_map(
      data_sf = ym_data_sf,
      fill_var = "log_10_n_vms_records",
      fill_range = state_fill_range,
      background_sf = west_coast_states,
      map_bbox = state_bbox,
      title_label = paste(substr(ym, 1, 4), month.name[as.numeric(substr(ym, 6, 7))]),
      fill_label = "Log-10 Interpolated VMS Records",
      png_name = here("Confidential", "hindcast_output",  output_subdir_name, "maps/monthly/", paste0(s, "/log_10_n_vms_records_", ym, ".png"))
    )
  }
}
```

```{r, include=FALSE}
# end timer
end_timer <- proc.time()
total_timer <- end_timer - start_timer
```

This script took `r round(total_timer[3]/60, 2)` minutes to run.