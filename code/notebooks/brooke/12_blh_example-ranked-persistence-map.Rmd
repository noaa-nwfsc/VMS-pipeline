---
title: "12_blh_example-ranked-persistence-map"
author: "Brooke Hawkins"
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# import libraries
library(tidyverse)

# set seed for reproducibility
set.seed(37)
```

Create a ranked persistence map, which will visualize the top X% of fishing activity based on the number of interpolated pings for a given year in a given grid cell. X will be our cutoff or threshold (I'm using those terms interchangeably).

For simplicity, I use `year` (e.g. 2013) in these examples, but in the actual mapping code, I use use `crab_year` (e.g. 2013_2014 for Nov. 2013 - Oct. 2014).

## Simple - Coast - All time

There are a few versions of this map, let's start with the simple version for the whole coast and the whole time frame.

Consider a simple example, for three grid cells in three years. 

```{r make-example-1}
ex_1_df <- tibble(year = c(rep(2013, 3), rep(2014, 3), rep(2015, 3)),
                  grid_cell = c(letters[1:3], sample(letters[1:3]), sample(letters[1:3])),
                  n_pings = c(75, 10, 15, 160, 30, 10, 60, 20, 20))
ex_1_df
```

For each grid cell, calculate how many years the grid cell had any fishing activity.

```{r}
ex_1_map_df <- ex_1_df %>%
  group_by(grid_cell) %>%
  summarise(years_with_activity = n_distinct(year),
            .groups = 'drop')

ex_1_map_df
```

This dataframe would then be joined to the 5km grid by `grid_cell`, and plotted on a map. Each grid cell had activity in every year, so every cell would be included on the map with 3 years of activity. 

## Ranked - Coast - All time

Let's make it a little trickier. Now we only want to consider grid cells that contribute to the top X% of fishing activity. We'll still consider the whole coast and the whole time frame.

Let's consider a 75% threshold.

```{r set-threshold}
threshold <- 0.75
```

To decide which grid cells contribute towards the 75% fishing activity, we need to do a couple of things:

1. Sort each year of data from most pings to fewest pings
2. Calculate total number of pings per year
3. Calculate the threshold number of pings per year (if it's a fraction, round up to the nearest whole number)
4. Calculate a cumulative sum of number of pings for each year
5. Compare the cumulative number of pings to the threshold number of pings to decide which cells get included in the persistence map

```{r}
ex_1_threshold_df <- ex_1_df %>%
  arrange(year, n_pings * -1) %>%
  group_by(year) %>% 
  mutate(year_pings = sum(n_pings),
         threshold_pings = ceiling(threshold * year_pings)) %>%
  ungroup() %>%
  group_by(year) %>% 
  mutate(cumulative_pings = cumsum(n_pings),
         include = (cumulative_pings <= threshold_pings) | 
           (cumulative_pings > threshold_pings & lag(cumulative_pings) < threshold_pings) | 
           (cumulative_pings > threshold_pings & is.na(lag(cumulative_pings) < threshold_pings)))

ex_1_threshold_df
```

This logic for `include` probably seems arbitrarily complicated, but here are a few use cases considered here:

* What if the cumulative pings is exactly equal to the threshold pings? (2013)
* What if cumulative pings is not exactly equal to the threshold pings? (2014, 2015)
* What if the first record reaches the threshold? (2014)

Not *exactly* 75% of the fishing effort is included; it's more accurate to say at least 75% fishing effort is included. For example, in 2014 and in 2015, 80% of the effort is included.

Edge case - I'm still not satisfied with ties at the threshold. For example, in 2015, grid cells b and c both have 20 pings, and grid cell b is included while grid cell c isn't. I haven't figured out a way to handle that exception without iterating over records one by one in a for loop, which seems slow. I did see this happen in the actual VMS data for the 2016-2017 crab year. I doubt it has huge impacts on the maps, just calling out this one remaining caveat.

Anyway, moving on.

When mapping persistence for grid cells that contribute to the top 75% of fishing activity, we now need to find how many years each of the grid cells are included. The steps are:

1. Filter for grid cells that should be included in the summary
2. Count the number of distinct years for each grid cell

```{r}
ex_1_threshold_map_df <- ex_1_threshold_df %>%
  filter(include) %>%
  group_by(grid_cell) %>%
  summarize(years_with_activity = n_distinct(year),
            .groups = 'drop')

ex_1_threshold_map_df
```

Only grid cells a and b contributed towards the top 75% fishing effort, and in 2 years each.

Note: the ranked version for a 100% threshold is identical to the simple version. The 100% threshold will just do some sorting and calculating that isn't required, because every value for `include` will be true until 100% of the pings are represented.

